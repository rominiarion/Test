<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOMMY - LOCAL MULTIPLAYER</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #0b0c10; --grid-bg: #1f2833; --cell-empty: #2c3540;
            --accent: #ff007f; --accent-dim: #9b004f; --text-primary: #ffffff;
            --text-secondary: #c5c6c7; --gold: #ffd700; --danger: #ff4b4b;
        }
        * { box-sizing: border-box; touch-action: none; user-select: none; font-family: 'Segoe UI', sans-serif; }
        body { margin: 0; background: var(--bg-color); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; align-items: center; justify-content: center; }

        #bloodOverlay { position: fixed; inset: 0; pointer-events: none; z-index: 2000; background: radial-gradient(circle, transparent 40%, rgba(139, 0, 0, 0.7) 100%); opacity: 0; transition: opacity 0.4s; }

        @keyframes softPulse { 0% { transform: scale(1); } 50% { transform: scale(1.005); } 100% { transform: scale(1); } }
        @keyframes heavyPulse { 0% { transform: translate(1px, 1px); } 25% { transform: translate(-1px, -2px); } 50% { transform: translate(-2px, 1px); } 75% { transform: translate(1px, 2px); } 100% { transform: translate(0, 0); } }
        
        .pulse-soft { animation: softPulse 0.5s infinite; }
        .pulse-heavy { animation: heavyPulse 0.2s infinite; }

        #loader { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-color); z-index: 1000; overflow-y: auto; padding: 20px; }
        .hidden { display: none !important; }

        .menu-btn {
            width: 260px; padding: 15px; margin: 10px; background: transparent;
            border: 2px solid var(--accent); color: var(--accent); font-size: 1.1rem;
            font-weight: bold; cursor: pointer; border-radius: 12px; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .menu-btn:hover { background: var(--accent); color: var(--bg-color); box-shadow: 0 0 20px var(--accent); }
        .menu-btn:disabled { border-color: #333; color: #333; cursor: not-allowed; box-shadow: none; }

        .header { width: 100%; max-width: 450px; display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; position: fixed; top: 25px; z-index: 100; }
        .hud-item { display: flex; flex-direction: column; }
        .nav-btns { display: flex; gap: 5px; }
        .exit-btn { background: rgba(255,0,127,0.1); border: 1px solid var(--accent); color: var(--accent); padding: 8px 10px; border-radius: 8px; font-weight: bold; font-size: 0.7rem; cursor: pointer; }

        .timer-container { position: fixed; top: 0; left: 0; width: 100%; height: 10px; background: rgba(255,255,255,0.05); z-index: 101; }
        .timer-bar { height: 100%; background: var(--accent); width: 100%; transition: width 0.1s linear; }
        .timer-text { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); font-weight: 900; font-size: 1.1rem; color: var(--accent); text-shadow: 0 0 5px #000; }

        .game-area { margin-top: 100px; display: flex; flex-direction: column; align-items: center; width: 100%; filter: none !important; }
        .grid { width: 92vw; max-width: 380px; aspect-ratio: 1; background: var(--grid-bg); border-radius: 12px; padding: 6px; display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative; }
        .cell { background: var(--cell-empty); border-radius: 4px; aspect-ratio: 1; transition: background 0.2s; }
        .cell.ghost { background: rgba(255,255,255,0.3) !important; border: 2px solid #fff; }
        .cell.selectable { cursor: crosshair; border: 1px solid var(--accent); box-shadow: inset 0 0 10px var(--accent-dim); }
        
        .powerup-bar { width: 92vw; max-width: 380px; display: flex; justify-content: space-between; margin: 15px 0 5px 0; }
        .pwr-btn { background: var(--grid-bg); border: 1px solid var(--accent-dim); color: var(--accent); border-radius: 8px; width: 31%; height: 45px; font-weight: bold; font-size: 0.65rem; transition: 0.2s; }
        .pwr-btn.active { background: var(--accent); color: var(--bg-color); box-shadow: 0 0 15px var(--accent); transform: scale(1.05); }

        .dock { width: 100%; max-width: 450px; height: 120px; display: flex; justify-content: space-around; align-items: center; }
        .slot { width: 31%; height: 100%; display: flex; justify-content: center; align-items: center; background: rgba(255,255,255,0.02); border-radius: 10px; }
        
        .shape-preview { display: grid; gap: 2px; pointer-events: none; }
        .block { width: 18px; height: 18px; border-radius: 3px; }
        .shape-preview.dragging { position: fixed; z-index: 9999; gap: 4px; }
        .shape-preview.dragging .block { width: var(--drag-size); height: var(--drag-size); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #gameOverBtns { display: none; flex-direction: column; align-items: center; margin-top: 20px; }

        /* Multiplayer UI */
        .mp-container { width: 300px; background: var(--grid-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--accent-dim); }
        .player-tag { background: rgba(0,0,0,0.3); padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .kick-btn { color: var(--danger); font-size: 0.7rem; border: 1px solid var(--danger); padding: 2px 5px; border-radius: 4px; cursor: pointer; }
        .mp-hud { position: fixed; bottom: 130px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px; border-radius: 10px; border: 1px solid var(--accent); width: 92vw; max-width: 380px; display: flex; justify-content: space-around; font-size: 0.8rem; z-index: 100; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-alive { background: #2ecc71; }
        .status-dead { background: var(--danger); }
        #roomInput { background: #000; border: 1px solid var(--accent); color: #fff; padding: 10px; width: 100%; border-radius: 8px; margin-bottom: 10px; text-align: center; }
        .id-badge { background: #1a1a1a; color: var(--accent); padding: 10px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; cursor: pointer; margin-bottom: 15px; display: block; border: 1px dashed var(--accent-dim); text-align: center; }
        .id-badge.ready { background: var(--accent); color: #fff; border-style: solid; box-shadow: 0 0 10px var(--accent-dim); }
    </style>
</head>
<body>

    <div id="bloodOverlay"></div>

    <div id="loader">
        <div style="width:50px; height:50px; border:5px solid var(--grid-bg); border-top-color:var(--accent); border-radius:50%; animation:heavyPulse 1s infinite"></div>
        <p style="margin-top:20px; color:var(--accent); letter-spacing: 2px;">MOMMY HAZIRLANIYOR...</p>
    </div>

    <div id="screenMenu" class="screen hidden">
        <h1 style="color:var(--accent); font-size: 4.5rem; text-shadow: 0 0 25px var(--accent); margin-bottom: 30px;">MOMMY</h1>
        <button class="menu-btn" onclick="game.uiShowPlayMode()">OYNA</button>
        <button class="menu-btn" onclick="game.uiShowSettings()">AYARLAR</button>
    </div>

    <div id="screenPlayMode" class="screen hidden">
        <h2 style="color:var(--accent); margin-bottom: 30px;">OYUN MODU</h2>
        <button class="menu-btn" onclick="game.showModSelection()">TEK OYUNCULU</button>
        <button class="menu-btn" onclick="game.uiShowMpHub()">√áOK OYUNCULU</button>
        <button class="menu-btn" onclick="game.uiShowMenu()" style="border-color:var(--text-secondary); color:var(--text-secondary)">GERƒ∞</button>
    </div>

    <div id="screenMpHub" class="screen hidden">
        <h2 style="color:var(--accent); margin-bottom: 20px;">√áOK OYUNCULU</h2>
        <div class="mp-container">
            <p id="connStatus" style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 5px; text-align: center;">MODEMLE ƒ∞LETƒ∞≈ûƒ∞M KURULUYOR...</p>
            <div id="myIdDisplay" class="id-badge" onclick="game.copyMyId()">BAƒûLANILIYOR...</div>
            
            <button class="menu-btn" id="hostBtn" style="width:100%; margin: 10px 0;" onclick="game.mpHostRoom()" disabled>ODA OLU≈ûTUR</button>
            <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
            <input type="text" id="roomInput" placeholder="ARKADA≈ûININ ID'Sƒ∞Nƒ∞ Gƒ∞R">
            <button class="menu-btn" id="joinBtn" style="width:100%; margin: 0;" onclick="game.mpJoinRoom()" disabled>ODAYA KATIL</button>
        </div>
        <button class="menu-btn" onclick="game.uiShowPlayMode()" style="margin-top:20px; border-color:var(--text-secondary); color:var(--text-secondary)">GERƒ∞</button>
    </div>

    <div id="screenMpLobby" class="screen hidden">
        <h2 style="color:var(--gold); margin-bottom: 10px;">ODA LOBƒ∞Sƒ∞</h2>
        <div id="lobbyIdDisplay" style="color:var(--accent); font-weight:bold; margin-bottom:20px; font-size:0.9rem; text-transform: uppercase;">ODA ID: ---</div>
        
        <div class="mp-container">
            <div id="playerList">
                <div class="player-tag"><span>Sƒ∞Z (HOST)</span></div>
            </div>
            
            <div id="hostControls" style="margin-top:20px;">
                <label style="font-size:0.7rem;">OYUN MODU SE√áƒ∞N</label>
                <select id="mpModeSelect" style="width:100%; background:#000; color:#fff; border:1px solid var(--accent); padding:8px; border-radius:5px; margin:10px 0;">
                    <option value="normal">NORMAL MOD</option>
                    <option value="timed">S√úRELƒ∞ MOD</option>
                </select>
                <button class="menu-btn" id="mpStartBtn" style="width:100%; margin:0;" disabled onclick="game.mpStartMatch()">MA√áI BA≈ûLAT</button>
            </div>
            <p id="guestWaitMsg" class="hidden" style="font-size:0.8rem; color:var(--text-secondary); text-align:center;">Hostun oyunu ba≈ülatmasƒ± bekleniyor...</p>
        </div>
        <button class="menu-btn" onclick="game.mpLeaveRoom()" style="margin-top:20px; border-color:var(--danger); color:var(--danger)">AYRIL</button>
    </div>

    <div id="screenMods" class="screen hidden">
        <h2 style="color:var(--accent); margin-bottom: 30px;">TEK OYUNCULU</h2>
        <button class="menu-btn" onclick="game.start('normal')">NORMAL MOD<span style="font-size:0.7rem; opacity:0.6">REKOR: <span id="recordNormal">0</span></span></button>
        <button class="menu-btn" onclick="game.start('timed')">S√úRELƒ∞ MOD<span style="font-size:0.7rem; opacity:0.6">REKOR: <span id="recordTimed">0</span></span></button>
        <button class="menu-btn" onclick="game.uiShowPlayMode()" style="border-color:var(--text-secondary); color:var(--text-secondary)">GERƒ∞</button>
    </div>

    <div id="screenSettings" class="screen hidden">
        <div style="background:var(--grid-bg); padding:30px; border-radius:15px; width:320px; border:1px solid var(--accent-dim)">
            <h2 style="color:var(--accent); margin-top:0">AYARLAR</h2>
            <label>M√ºzik Sesi</label><input type="range" id="volMusic" min="0" max="1" step="0.1" style="width:100%; margin: 10px 0 20px 0">
            <label>Efekt Sesi</label><input type="range" id="volSfx" min="0" max="1" step="0.1" style="width:100%; margin: 10px 0 20px 0">
            <button class="menu-btn" onclick="game.uiShowMenu()" style="width:100%; margin:0">GERƒ∞ D√ñN</button>
        </div>
    </div>

    <div class="header" id="gameHUD" style="display:none">
        <div class="nav-btns">
            <button class="exit-btn" onclick="game.uiShowMenu()">MEN√ú</button>
            <button class="exit-btn" id="resetBtn" style="border-color:var(--gold); color:var(--gold)" onclick="game.reset()">TEKRAR</button>
        </div>
        <div class="hud-item" style="align-items: center;">
            <span style="font-size:0.6rem; color:var(--text-secondary)">SKOR</span>
            <span id="scoreTxt" style="font-weight:800; font-size:1.2rem">0</span>
        </div>
        <div class="hud-item" style="align-items: flex-end;">
            <span style="font-size:0.6rem; color:var(--text-secondary)">ALTIN</span>
            <span id="goldTxt" style="font-weight:800; color:var(--gold); font-size:1.2rem">0</span>
        </div>
    </div>

    <div class="mp-hud hidden" id="mpHUD">
        <div>Sƒ∞Z: <span id="myMpStatus" class="status-dot status-alive"></span> <span id="myMpScore">0</span></div>
        <div style="color:var(--accent); font-weight:bold;">VS</div>
        <div>RAKƒ∞P: <span id="oppMpStatus" class="status-dot status-alive"></span> <span id="oppMpScore">0</span></div>
    </div>

    <div class="timer-container" id="timerBox" style="display:none">
        <div id="timerBar" class="timer-bar"></div>
        <div id="timerVal" class="timer-text">25.0s</div>
    </div>

    <div id="gameBody" class="game-area">
        <div class="grid" id="grid"></div>
        <div class="powerup-bar">
            <button class="pwr-btn" id="pwr-single" onclick="game.togglePwr('single')">TEK Sƒ∞L<br>150 G</button>
            <button class="pwr-btn" id="pwr-cross" onclick="game.togglePwr('cross')">+ Sƒ∞L<br>500 G</button>
            <button class="pwr-btn" id="pwr-nuke" onclick="game.togglePwr('nuke')">TEMƒ∞ZLE<br>1000 G</button>
        </div>
        <div class="dock">
            <div class="slot" id="slot0" onmousedown="game.handleGrab(event,0)" ontouchstart="game.handleGrab(event,0)"></div>
            <div class="slot" id="slot1" onmousedown="game.handleGrab(event,1)" ontouchstart="game.handleGrab(event,1)"></div>
            <div class="slot" id="slot2" onmousedown="game.handleGrab(event,2)" ontouchstart="game.handleGrab(event,2)"></div>
        </div>
    </div>

    <div id="overlay" class="overlay">
        <h2 id="overTitle" style="color:var(--danger); font-size: 3.5rem; margin:0; text-shadow: 0 0 20px var(--danger);">OYUN Bƒ∞TTƒ∞</h2>
        <p id="finalScore" style="font-size: 1.6rem; margin: 15px 0;">SKOR: 0</p>
        <p id="mpStats" style="font-size: 1rem; color: var(--gold); text-align:center;"></p>
        <div id="gameOverBtns">
            <button class="menu-btn" id="retryBtn" onclick="game.reset()">YENƒ∞DEN DENE</button>
            <button class="menu-btn" onclick="game.uiShowMenu()" style="border-color:var(--text-secondary); color:var(--text-secondary)">ANA MEN√ú</button>
        </div>
    </div>

    <script>
        const Sound = {
            music: new Audio(), volM: 0.5, volS: 0.5,
            tracks: { 
                menu: "https://raw.githubusercontent.com/rominiarion/Test/main/1.mp3", 
                game: "https://raw.githubusercontent.com/rominiarion/Test/main/2.mp3",
                timed: "https://raw.githubusercontent.com/rominiarion/Test/main/3.mp3"
            },
            async load() {
                try {
                    const loads = Object.values(this.tracks).map(url => fetch(url).then(r => r.blob()));
                    await Promise.all(loads);
                    game.initAudio();
                } catch(e) { game.initAudio(); }
            },
            play(key) {
                const targetSrc = this.tracks[key];
                if (this.music.src === targetSrc) return;
                this.music.pause(); this.music.src = targetSrc;
                this.music.volume = this.volM; this.music.loop = true;
                this.music.play().catch(() => { window.addEventListener('click', () => this.music.play(), {once: true}); });
            },
            sfx(f1, f2) {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const o = ctx.createOscillator(), g = ctx.createGain();
                    o.frequency.setValueAtTime(f1, ctx.currentTime);
                    if(f2) o.frequency.exponentialRampToValueAtTime(f2, ctx.currentTime+0.1);
                    g.gain.setValueAtTime(this.volS*0.1, ctx.currentTime);
                    o.connect(g); g.connect(ctx.destination);
                    o.start(); o.stop(ctx.currentTime+0.1);
                } catch(e){}
            }
        };

        class Game {
            constructor() {
                this.save = JSON.parse(localStorage.getItem('mommy_v6')) || { gold: 0, normal: 0, timed: 0, volM: 0.5, volS: 0.5 };
                this.grid = Array(8).fill().map(() => Array(8).fill(null));
                this.score = 0; this.timer = { current: 25, max: 25, active: false, startTime: 0, finishTime: 0 };
                this.currentShapes = [null,null,null]; this.gridEl = document.getElementById('grid');
                this.activePwr = null; this.gameOverTriggered = false;
                
                this.peer = null; this.conn = null; this.myId = null;
                this.isHost = false; this.isMp = false;
                this.oppScore = 0; this.oppAlive = true; this.oppFinishTime = 0;

                this.init();
            }

            init() {
                Sound.load(); this.renderGrid(); this.updateUI();
                setInterval(() => this.tick(), 100);
                setTimeout(() => { if(this.gridEl.children.length > 0) { this.cellSize = this.gridEl.children[0].offsetWidth; document.documentElement.style.setProperty('--drag-size', this.cellSize + 'px'); } }, 1000);
                this.connectToPeer();
            }

            connectToPeer() {
                if(this.peer) try { this.peer.destroy(); } catch(e){}
                
                // Yerel aƒüda √ßalƒ±≈üabilmek i√ßin ICE sunucularƒ±nƒ± ve Peer konfig√ºrasyonunu zorla
                this.peer = new Peer({
                    config: {
                        'iceServers': [
                            { url: 'stun:stun.l.google.com:19302' },
                            { url: 'stun:stun1.l.google.com:19302' }
                        ]
                    },
                    debug: 0
                });
                
                this.peer.on('open', id => { 
                    this.myId = id;
                    const badge = document.getElementById('myIdDisplay');
                    badge.innerText = id; 
                    badge.classList.add('ready');
                    document.getElementById('hostBtn').disabled = false;
                    document.getElementById('joinBtn').disabled = false;
                    document.getElementById('connStatus').innerText = "BAƒûLANTI HAZIR";
                    document.getElementById('connStatus').style.color = "#2ecc71";
                });

                this.peer.on('connection', c => {
                    if(this.conn) { c.close(); return; } 
                    this.conn = c; this.isHost = true;
                    this.setupConn();
                });

                this.peer.on('error', err => {
                    document.getElementById('connStatus').innerText = "HATA: " + err.type.toUpperCase();
                    document.getElementById('connStatus').style.color = "var(--danger)";
                    if(err.type === 'peer-unavailable') alert("Oda bulunamadƒ±! ID'yi doƒüru girdiƒüinizden emin olun.");
                    setTimeout(() => this.connectToPeer(), 10000);
                });

                this.peer.on('disconnected', () => this.peer.reconnect());
            }

            copyMyId() {
                if(!this.myId) return;
                const dummy = document.createElement("input");
                document.body.appendChild(dummy);
                dummy.value = this.myId;
                dummy.select();
                document.execCommand("copy");
                document.body.removeChild(dummy);
                const b = document.getElementById('myIdDisplay');
                const old = b.innerText;
                b.innerText = "KOPYALANDI!";
                setTimeout(() => b.innerText = old, 1000);
            }

            setupConn() {
                this.conn.on('open', () => this.updateMpLobbyUI());
                this.conn.on('data', data => {
                    if(data.type === 'kick') { alert("Odadan atƒ±ldƒ±nƒ±z!"); location.reload(); }
                    if(data.type === 'start') { this.isMp = true; this.start(data.mode); }
                    if(data.type === 'sync') { this.oppScore = data.score; this.oppAlive = data.alive; this.updateHUD(); }
                    if(data.type === 'finish') { this.oppAlive = false; this.oppFinishTime = data.time; this.checkMatchEnd(); }
                });
                this.conn.on('close', () => { if(this.isMp) { alert("Rakip ayrƒ±ldƒ±!"); location.reload(); } });
                this.updateMpLobbyUI();
            }

            updateMpLobbyUI() {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById('screenMpLobby').classList.remove('hidden');
                document.getElementById('lobbyIdDisplay').innerText = "ODA ID: " + (this.isHost ? this.myId : (this.conn ? this.conn.peer : "---"));
                const list = document.getElementById('playerList');
                list.innerHTML = `<div class="player-tag"><span>Sƒ∞Z (${this.isHost?'HOST':'KATILIMCI'})</span></div>`;
                if(this.conn && this.conn.open) {
                    const kickBtn = this.isHost ? `<span class="kick-btn" onclick="game.mpKick()">AT</span>` : '';
                    list.innerHTML += `<div class="player-tag"><span>RAKƒ∞P</span> ${kickBtn}</div>`;
                    if(this.isHost) document.getElementById('mpStartBtn').disabled = false;
                } else if(this.isHost) {
                    document.getElementById('mpStartBtn').disabled = true;
                }
                if(!this.isHost) {
                    document.getElementById('hostControls').classList.add('hidden');
                    document.getElementById('guestWaitMsg').classList.remove('hidden');
                } else {
                    document.getElementById('hostControls').classList.remove('hidden');
                    document.getElementById('guestWaitMsg').classList.add('hidden');
                }
            }

            mpHostRoom() { if(!this.myId) return; this.isHost = true; this.updateMpLobbyUI(); }
            mpJoinRoom() {
                const id = document.getElementById('roomInput').value.trim();
                if(!id || !this.myId) return;
                this.conn = this.peer.connect(id, { reliable: true });
                this.isHost = false;
                this.setupConn();
            }

            mpKick() { if(this.conn) { this.conn.send({type:'kick'}); this.conn.close(); this.conn = null; this.updateMpLobbyUI(); } }
            mpLeaveRoom() { location.reload(); }
            mpStartMatch() {
                if(!this.conn || !this.conn.open) return;
                const mode = document.getElementById('mpModeSelect').value;
                this.conn.send({type: 'start', mode: mode});
                this.isMp = true;
                this.start(mode);
            }

            syncSave() { localStorage.setItem('mommy_v6', JSON.stringify(this.save)); }
            initAudio() { document.getElementById('loader').classList.add('hidden'); this.uiShowMenu(); }
            uiShowPlayMode() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('screenPlayMode').classList.remove('hidden'); }
            uiShowMpHub() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('screenMpHub').classList.remove('hidden'); }
            showModSelection() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('screenMods').classList.remove('hidden'); }
            uiShowSettings() { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById('screenSettings').classList.remove('hidden'); }
            
            uiShowMenu() { 
                this.timer.active = false; this.gameOverTriggered = false; this.isMp = false;
                document.getElementById('timerBox').style.display = 'none';
                document.getElementById('gameHUD').style.display = 'none';
                document.getElementById('mpHUD').classList.add('hidden');
                document.getElementById('bloodOverlay').style.opacity = 0;
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
                document.getElementById('screenMenu').classList.remove('hidden'); 
                document.getElementById('overlay').style.display = 'none';
                this.clearGhost(); Sound.play('menu'); this.updateUI(); 
            }

            start(mode) {
                this.currentMode = mode; this.score = 0; this.grid = this.grid.map(r => r.fill(null));
                this.timer.max = 25; this.timer.current = 25; this.timer.active = (mode === 'timed');
                this.timer.startTime = Date.now();
                this.oppAlive = true; this.oppScore = 0;
                this.gameOverTriggered = false; this.activePwr = null;
                document.getElementById('gameHUD').style.display = 'flex';
                document.getElementById('timerBox').style.display = (mode === 'timed' ? 'block' : 'none');
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById('overlay').style.display = 'none';
                if(this.isMp) {
                    document.getElementById('mpHUD').classList.remove('hidden');
                    document.getElementById('retryBtn').style.display = 'none';
                    document.getElementById('resetBtn').style.display = 'none';
                    this.updateHUD();
                } else {
                    document.getElementById('retryBtn').style.display = 'flex';
                    document.getElementById('resetBtn').style.display = 'flex';
                }
                Sound.play(mode === 'timed' ? 'timed' : 'game');
                this.refreshGrid(); this.updateUI(); this.spawnShapes();
            }

            tick() {
                if(!this.timer.active) return;
                this.timer.current -= 0.1;
                const bar = document.getElementById('timerBar'), tVal = document.getElementById('timerVal'), blood = document.getElementById('bloodOverlay'), body = document.getElementById('gameBody');
                bar.style.width = (this.timer.current / this.timer.max * 100) + '%';
                tVal.innerText = Math.max(0, this.timer.current).toFixed(1) + "s";
                if(this.timer.current <= 15) {
                    body.className = 'game-area ' + (this.timer.current <= 6 ? 'pulse-heavy' : 'pulse-soft');
                    blood.style.opacity = (15 - this.timer.current) / 18;
                } else { body.className = 'game-area'; blood.style.opacity = 0; }
                if(this.timer.current <= 0) this.endGame("S√úRE Bƒ∞TTƒ∞");
            }

            updateHUD() {
                document.getElementById('myMpScore').innerText = this.score;
                document.getElementById('oppMpScore').innerText = this.oppScore;
                document.getElementById('myMpStatus').className = 'status-dot ' + (this.gameOverTriggered || (this.currentMode==='timed' && this.timer.current<=0) ? 'status-dead' : 'status-alive');
                document.getElementById('oppMpStatus').className = 'status-dot ' + (this.oppAlive ? 'status-alive' : 'status-dead');
            }

            endGame(reason) {
                if(this.timer.active === false && this.gameOverTriggered && this.isMp) return;
                this.timer.active = false;
                this.timer.finishTime = Math.floor((Date.now() - this.timer.startTime) / 1000);
                if(this.score > this.save[this.currentMode]) this.save[this.currentMode] = this.score;
                this.syncSave();
                if(this.isMp) {
                    this.conn.send({type:'finish', time: this.timer.finishTime});
                    this.updateHUD();
                    this.checkMatchEnd();
                } else this.showResult(reason);
            }

            checkMatchEnd() {
                const imDead = this.gameOverTriggered || (this.currentMode==='timed' && this.timer.current<=0);
                if(!this.oppAlive && imDead) this.showResult("MA√á TAMAMLANDI");
            }

            showResult(reason) {
                document.getElementById('overTitle').innerText = reason;
                document.getElementById('finalScore').innerText = "SKORUNUZ: " + this.score;
                if(this.isMp) {
                    let msg = `Siz: ${this.timer.finishTime}sn | Rakip: ${this.oppFinishTime}sn\n`;
                    if(this.score > this.oppScore) msg += "KAZANDINIZ! üèÜ";
                    else if(this.score < this.oppScore) msg += "KAYBETTƒ∞Nƒ∞Z!";
                    else msg += "BERABERE!";
                    document.getElementById('mpStats').innerText = msg;
                } else document.getElementById('mpStats').innerText = "";
                document.getElementById('overlay').style.display = 'flex';
                document.getElementById('gameOverBtns').style.display = 'none';
                setTimeout(() => { document.getElementById('gameOverBtns').style.display = 'flex'; }, 2000);
            }

            togglePwr(type) {
                const costs = { single: 150, cross: 500, nuke: 1000 };
                if(this.activePwr === type) this.activePwr = null;
                else if(this.save.gold >= costs[type]) {
                    if(type === 'nuke') {
                        this.save.gold -= 1000; this.grid = this.grid.map(r => r.fill(null));
                        this.refreshGrid(); this.syncSave(); this.updateUI(); Sound.sfx(200, 1000);
                        this.spawnShapes();
                    } else { this.activePwr = type; Sound.sfx(800, 900); }
                }
                document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('active'));
                if(this.activePwr) document.getElementById('pwr-'+type).classList.add('active');
                this.refreshGrid();
            }

            handleCellClick(r, c) {
                if(!this.activePwr) return;
                if(this.activePwr === 'single') { this.grid[r][c] = null; this.save.gold -= 150; }
                else if(this.activePwr === 'cross') { for(let i=0; i<8; i++) { this.grid[r][i] = null; this.grid[i][c] = null; } this.save.gold -= 500; }
                this.activePwr = null;
                document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('active'));
                this.refreshGrid(); this.syncSave(); this.updateUI(); Sound.sfx(500, 200);
                this.gameOverTriggered = false; this.spawnShapes();
                if(this.isMp) this.conn.send({type:'sync', score:this.score, alive:true});
            }

            spawnShapes() {
                for(let i=0; i<3; i++) if(!this.currentShapes[i]) {
                    const m = [[[1]], [[1,1]], [[1,1,1]], [[1,1,1,1]], [[1,1],[1,1]], [[1,1,1],[0,1,0]], [[1,0],[1,0],[1,1]], [[1,1,0],[0,1,1]]][Math.floor(Math.random()*8)];
                    const c = ['#f39c12', '#e74c3c', '#8e44ad', '#3498db', '#2ecc71'][Math.floor(Math.random()*5)];
                    this.currentShapes[i] = { matrix: m, color: c };
                    this.drawSlot(i, m, c);
                }
                this.checkMovesLeft();
            }

            checkMovesLeft() {
                const hasAnyMove = this.currentShapes.some(s => {
                    if(!s) return false;
                    for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(this.canPlace(s.matrix, r, c)) return true;
                    return false;
                });
                if(!hasAnyMove && !this.gameOverTriggered) {
                    this.gameOverTriggered = true;
                    setTimeout(() => { if(this.gameOverTriggered) this.endGame("YER KALMADI"); }, 2000);
                }
            }

            handleGrab(e, idx) {
                if(!this.currentShapes[idx] || this.activePwr) return;
                e.preventDefault(); Sound.sfx(600, 800);
                const el = document.getElementById('p-'+idx), m = this.currentShapes[idx].matrix;
                this.dragged = { el, idx, data: this.currentShapes[idx], parent: el.parentNode, pR: Math.floor(m.length/2), pC: Math.floor(m[0].length/2) };
                el.classList.add('dragging'); document.body.appendChild(el);
                this.onMove(e);
            }

            onMove(e) {
                if(!this.dragged) return;
                const t = e.touches ? e.touches[0] : e, bS = this.cellSize + 4;
                this.dragged.el.style.left = (t.clientX - (this.dragged.pC * bS) - (this.cellSize/2)) + 'px';
                this.dragged.el.style.top = (t.clientY - (this.dragged.pR * bS) - (this.cellSize/2) - 80) + 'px';
                this.clearGhost();
                const pos = this.getGridPos(t.clientX, t.clientY - 80);
                if(pos) {
                    const sR = pos.r - this.dragged.pR, sC = pos.c - this.dragged.pC;
                    if(this.canPlace(this.dragged.data.matrix, sR, sC)) {
                        this.dragged.data.matrix.forEach((row, i) => row.forEach((v, j) => {
                            if(v) { const trgt = (sR+i)*8+(sC+j); if(trgt >=0 && trgt < 64) this.gridEl.children[trgt].classList.add('ghost'); }
                        }));
                    }
                }
            }

            endDrag(e) {
                if(!this.dragged) return;
                const t = e.changedTouches ? e.changedTouches[0] : e, pos = this.getGridPos(t.clientX, t.clientY - 80);
                if(pos) {
                    const sR = pos.r - this.dragged.pR, sC = pos.c - this.dragged.pC;
                    if(this.canPlace(this.dragged.data.matrix, sR, sC)) {
                        this.dragged.data.matrix.forEach((row, i) => row.forEach((v, j) => { if(v) this.grid[sR+i][sC+j] = this.dragged.data.color; }));
                        this.score += 20; this.save.gold += 10;
                        this.currentShapes[this.dragged.idx] = null; this.dragged.el.remove();
                        Sound.sfx(400, 200);
                        if(this.currentMode === 'timed') { this.timer.max = Math.max(6, this.timer.max - 0.4); this.timer.current = this.timer.max; }
                        this.checkLines();
                        if(this.currentShapes.every(x=>x===null)) this.spawnShapes();
                        else this.checkMovesLeft();
                        this.syncSave(); this.updateUI();
                        if(this.isMp) this.conn.send({type:'sync', score:this.score, alive:true});
                    } else { this.dragged.el.classList.remove('dragging'); this.dragged.parent.appendChild(this.dragged.el); }
                } else { this.dragged.el.classList.remove('dragging'); this.dragged.parent.appendChild(this.dragged.el); }
                this.clearGhost(); this.refreshGrid(); this.dragged = null;
            }

            checkLines() {
                let rL = [], cL = [];
                for(let r=0; r<8; r++) if(this.grid[r].every(x=>x)) rL.push(r);
                for(let c=0; c<8; c++) { let f=true; for(let r=0; r<8; r++) if(!this.grid[r][c]) f=false; if(f) cL.push(c); }
                if(rL.length + cL.length > 0) {
                    this.score += (rL.length + cL.length) * 100; this.save.gold += (rL.length + cL.length) * 20;
                    rL.forEach(r => this.grid[r].fill(null)); cL.forEach(c => { for(let r=0; r<8; r++) this.grid[r][c]=null; });
                    Sound.sfx(800, 1000); if(this.currentMode === 'timed') this.timer.current = this.timer.max;
                }
            }

            updateUI() {
                document.getElementById('scoreTxt').innerText = this.score;
                document.getElementById('goldTxt').innerText = this.save.gold;
                document.getElementById('recordNormal').innerText = this.save.normal;
                document.getElementById('recordTimed').innerText = this.save.timed;
            }

            reset() { document.getElementById('overlay').style.display='none'; this.start(this.currentMode); }
            renderGrid() { this.gridEl.innerHTML = ''; for(let i=0; i<64; i++) { const c=document.createElement('div'); c.className='cell'; c.onclick = () => this.handleCellClick(Math.floor(i/8), i%8); this.gridEl.appendChild(c); } }
            refreshGrid() { for(let i=0; i<64; i++) { const el = this.gridEl.children[i]; el.style.backgroundColor = this.grid[Math.floor(i/8)][i%8] || 'var(--cell-empty)'; el.className = 'cell' + (this.activePwr ? ' selectable' : ''); } }
            getGridPos(x, y) { const r = this.gridEl.getBoundingClientRect(); const c = Math.floor((x-r.left)/(r.width/8)), row = Math.floor((y-r.top)/(r.height/8)); return (row>=0&&row<8&&c>=0&&c<8)?{r:row,c}:null; }
            canPlace(m, r, c) { return m.every((row, i) => row.every((v, j) => !v || (r+i>=0 && r+i<8 && c+j>=0 && c+j<8 && !this.grid[r+i][c+j]))); }
            clearGhost() { document.querySelectorAll('.ghost').forEach(x=>x.classList.remove('ghost')); }
            drawSlot(idx, m, color) { const s=document.getElementById('slot'+idx); s.innerHTML=''; const w=document.createElement('div'); w.className='shape-preview'; w.id='p-'+idx; w.style.gridTemplateColumns=`repeat(${m[0].length},1fr)`; m.forEach(row=>row.forEach(v=>{ const b=document.createElement('div'); if(v){b.className='block';b.style.backgroundColor=color;}else{b.style.width='18px';} w.appendChild(b); })); s.appendChild(w); }
        }

        const game = new Game();
        window.addEventListener('mousemove', e => game.onMove(e));
        window.addEventListener('touchmove', e => game.onMove(e), {passive:false});
        window.addEventListener('mouseup', e => game.endDrag(e));
        window.addEventListener('touchend', e => game.endDrag(e));
    </script>
</body>
</html>
