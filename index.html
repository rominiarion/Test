<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOMMY - ANÄ°MASYON EFEKTLERÄ°</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #0b0c10; --grid-bg: #1f2833; --cell-empty: #2c3540;
            --accent: #ff007f; --accent-dim: #9b004f; --text-primary: #ffffff;
            --text-secondary: #c5c6c7; --gold: #ffd700; --danger: #ff4b4b;
        }
        
        /* Tema renkleri */
        .theme-dark { --bg-color: #0b0c10; --grid-bg: #1f2833; --cell-empty: #2c3540; --accent: #ff007f; }
        .theme-purple { --bg-color: #1a0b2e; --grid-bg: #2d1b69; --cell-empty: #3a267a; --accent: #9d4edd; }
        .theme-turquoise { --bg-color: #0d1b2a; --grid-bg: #1b3a4b; --cell-empty: #2a4d5f; --accent: #06d6a0; }
        
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; font-family: 'Segoe UI', sans-serif; }
        body { 
            margin: 0; 
            background: var(--bg-color); 
            color: var(--text-primary); 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: fixed;
            transition: background 0.3s;
        }
        html, body { 
            overflow: hidden; 
            position: fixed; 
            width: 100%; 
            height: 100%; 
        }

        #bloodOverlay { position: fixed; inset: 0; pointer-events: none; z-index: 2000; background: radial-gradient(circle, transparent 40%, rgba(139, 0, 0, 0.7) 100%); opacity: 0; transition: opacity 0.3s; }

        @keyframes softPulse { 0% { transform: scale(1); } 50% { transform: scale(1.005); } 100% { transform: scale(1); } }
        @keyframes heavyPulse { 0% { transform: translate(1px, 1px); } 25% { transform: translate(-1px, -2px); } 50% { transform: translate(-2px, 1px); } 75% { transform: translate(1px, 2px); } 100% { transform: translate(0, 0); } }
        
        /* TatlÄ± animasyon efektleri */
        @keyframes cuteBounce { 
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes cuteSparkle {
            0% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }
        
        @keyframes epicExplosion {
            0% { transform: scale(0); opacity: 1; }
            70% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        @keyframes magicGlow {
            0%, 100% { box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #0ff, 0 0 20px #0ff; }
            50% { box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #0ff, 0 0 40px #0ff; }
        }
        
        @keyframes heartFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }
        
        @keyframes starSpin {
            0% { transform: rotate(0deg) scale(1); }
            100% { transform: rotate(360deg) scale(1.5); }
        }
        
        .pulse-soft { animation: softPulse 0.5s infinite; }
        .pulse-heavy { animation: heavyPulse 0.2s infinite; }
        
        /* Animasyon efekt sÄ±nÄ±flarÄ± */
        .cute-effect .block { animation: cuteBounce 0.5s ease-in-out; }
        .epic-effect .cell:not(.empty) { animation: epicExplosion 0.3s ease-out; }
        .magic-effect .cell:not(.empty) { animation: magicGlow 1s infinite; }

        #loader { position: fixed; inset: 0; background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .screen { 
            position: fixed; 
            inset: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: var(--bg-color); 
            z-index: 1000; 
            overflow-y: auto; 
            padding: 20px;
            width: 100vw;
            height: 100vh;
            transition: background 0.3s;
        }
        .hidden { display: none !important; }

        .menu-btn {
            width: 260px; padding: 15px; margin: 10px; background: transparent;
            border: 2px solid var(--accent); color: var(--accent); font-size: 1.1rem;
            font-weight: bold; cursor: pointer; border-radius: 12px; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .menu-btn:hover { background: var(--accent); color: var(--bg-color); box-shadow: 0 0 20px var(--accent); }
        .menu-btn:disabled { border-color: #333; color: #333; cursor: not-allowed; box-shadow: none; }

        .header { 
            width: 100%; 
            max-width: 450px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 20px; 
            position: fixed; 
            top: 25px; 
            z-index: 100; 
            left: 50%;
            transform: translateX(-50%);
        }
        .hud-item { display: flex; flex-direction: column; }
        .nav-btns { display: flex; gap: 5px; }
        .exit-btn { background: rgba(255,0,127,0.1); border: 1px solid var(--accent); color: var(--accent); padding: 8px 10px; border-radius: 8px; font-weight: bold; font-size: 0.7rem; cursor: pointer; }

        .timer-container { position: fixed; top: 0; left: 0; width: 100%; height: 10px; background: rgba(255,255,255,0.05); z-index: 101; }
        .timer-bar { height: 100%; background: var(--accent); width: 100%; transition: width 0.1s linear; }
        .timer-text { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); font-weight: 900; font-size: 1.1rem; color: var(--accent); text-shadow: 0 0 5px #000; }

        .game-area { 
            margin-top: 100px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
            filter: none !important; 
            position: relative;
            z-index: 1;
        }
        .grid { 
            width: 92vw; 
            max-width: 380px; 
            aspect-ratio: 1; 
            background: var(--grid-bg); 
            border-radius: 12px; 
            padding: 6px; 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            gap: 4px; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
            position: relative; 
        }
        .cell { background: var(--cell-empty); border-radius: 4px; aspect-ratio: 1; transition: background 0.2s; }
        .cell.ghost { background: rgba(255,255,255,0.3) !important; border: 2px solid #fff; }
        .cell.selectable { cursor: crosshair; border: 1px solid var(--accent); box-shadow: inset 0 0 10px var(--accent-dim); }
        
        .powerup-bar { 
            width: 92vw; 
            max-width: 380px; 
            display: flex; 
            justify-content: space-between; 
            margin: 15px 0 5px 0; 
        }
        .pwr-btn { 
            background: var(--grid-bg); 
            border: 1px solid var(--accent-dim); 
            color: var(--accent); 
            border-radius: 8px; 
            width: 31%; 
            height: 45px; 
            font-weight: bold; 
            font-size: 0.65rem; 
            transition: 0.2s; 
        }
        .pwr-btn.active { background: var(--accent); color: var(--bg-color); box-shadow: 0 0 15px var(--accent); transform: scale(1.05); }

        .dock { 
            width: 100%; 
            max-width: 450px; 
            height: 120px; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            margin-bottom: 10px;
        }
        .slot { width: 31%; height: 100%; display: flex; justify-content: center; align-items: center; background: rgba(255,255,255,0.02); border-radius: 10px; }
        
        .shape-preview { display: grid; gap: 2px; pointer-events: none; }
        .block { width: 18px; height: 18px; border-radius: 3px; position: relative; }
        .shape-preview.dragging { position: fixed; z-index: 9999; gap: 4px; }
        .shape-preview.dragging .block { width: var(--drag-size); height: var(--drag-size); }
        
        /* Ã–zel blok stilleri */
        .block.diamond { background: linear-gradient(45deg, #b9f2ff 30%, #7fffd4 70%); }
        .block.diamond::after {
            content: "â™¦";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #4169e1;
            font-size: 10px;
            font-weight: bold;
        }
        
        .block.emerald { background: linear-gradient(45deg, #50c878 30%, #00ff7f 70%); }
        .block.emerald::after {
            content: "â™ ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #006400;
            font-size: 10px;
            font-weight: bold;
        }
        
        .block.ruby { background: linear-gradient(45deg, #e0115f 30%, #ff69b4 70%); }
        .block.ruby::after {
            content: "â™¥";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #8b0000;
            font-size: 10px;
            font-weight: bold;
        }
        
        .block.sapphire { background: linear-gradient(45deg, #0f52ba 30%, #1e90ff 70%); }
        .block.sapphire::after {
            content: "â™£";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00008b;
            font-size: 10px;
            font-weight: bold;
        }
        
        .block.amber { background: linear-gradient(45deg, #ffbf00 30%, #ffd700 70%); }
        .block.amber::after {
            content: "â˜…";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff8c00;
            font-size: 10px;
            font-weight: bold;
        }
        
        /* Efekt partikÃ¼lleri */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 999;
        }
        
        .heart-particle {
            color: #ff69b4;
            font-size: 20px;
            animation: heartFloat 1s ease-out forwards;
        }
        
        .star-particle {
            color: #ffd700;
            font-size: 15px;
            animation: starSpin 0.5s linear infinite;
        }
        
        .sparkle-particle {
            width: 10px;
            height: 10px;
            background: gold;
            border-radius: 50%;
            animation: cuteSparkle 0.5s ease-out forwards;
        }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #gameOverBtns { display: none; flex-direction: column; align-items: center; margin-top: 20px; }

        /* Multiplayer UI */
        .mp-container { width: 300px; background: var(--grid-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--accent-dim); }
        .player-tag { background: rgba(0,0,0,0.3); padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .kick-btn { color: var(--danger); font-size: 0.7rem; border: 1px solid var(--danger); padding: 2px 5px; border-radius: 4px; cursor: pointer; }
        
        /* VS TABLOSU */
        .mp-hud { 
            position: fixed; 
            top: 90px; /* Game HUD'un hemen altÄ±na */
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.8); 
            padding: 8px 15px; 
            border-radius: 10px; 
            border: 1px solid var(--accent); 
            width: 92vw; 
            max-width: 380px; 
            display: flex; 
            justify-content: space-around; 
            font-size: 0.8rem; 
            z-index: 100; 
            font-weight: bold;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-alive { background: #2ecc71; }
        .status-dead { background: var(--danger); }
        #roomInput { background: #000; border: 1px solid var(--accent); color: #fff; padding: 10px; width: 100%; border-radius: 8px; margin-bottom: 10px; text-align: center; }
        .id-badge { background: #1a1a1a; color: var(--accent); padding: 10px; border-radius: 8px; font-weight: bold; font-size: 0.9rem; cursor: pointer; margin-bottom: 15px; display: block; border: 1px dashed var(--accent-dim); text-align: center; }
        .id-badge.ready { background: var(--accent); color: #fff; border-style: solid; box-shadow: 0 0 10px var(--accent-dim); }
        
        /* BaÄŸlantÄ± mesajÄ± */
        .connecting-msg { 
            font-size: 0.7rem; 
            color: var(--gold); 
            text-align: center; 
            margin-top: 5px; 
            font-style: italic; 
        }
        
        /* Yer kalmadÄ± timer - DÃœZELTÄ°LDÄ° */
        .no-space-timer {
            position: fixed;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 127, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            z-index: 1000;
            display: none;
            text-align: center;
            box-shadow: 0 0 20px rgba(255, 0, 127, 0.5);
            border: 2px solid white;
            min-width: 200px;
        }
        
        /* Oyun iÃ§i uyarÄ± mesajÄ± */
        .game-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1.2rem;
            z-index: 10000;
            display: none;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 0, 127, 0.7);
            border: 3px solid var(--accent);
            max-width: 80%;
            animation: alertPulse 0.5s infinite alternate;
        }
        
        @keyframes alertPulse {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        .alert-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .alert-btn {
            padding: 10px 20px;
            border: 2px solid var(--accent);
            background: transparent;
            color: var(--accent);
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .alert-btn:hover {
            background: var(--accent);
            color: black;
        }
        
        /* MARKET STILLERÄ° */
        .market-container {
            width: 90%;
            max-width: 400px;
            background: var(--grid-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--accent-dim);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .market-category {
            margin-bottom: 25px;
        }
        
        .market-category h3 {
            color: var(--accent);
            border-bottom: 1px solid var(--accent-dim);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .market-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        
        .market-item:hover {
            border-color: var(--accent-dim);
            transform: translateY(-2px);
        }
        
        .market-item-info {
            flex: 1;
        }
        
        .market-item-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        .market-item-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .market-item-price {
            color: var(--gold);
            font-weight: bold;
            font-size: 1.1rem;
            margin-left: 15px;
        }
        
        .market-item-owned {
            color: #2ecc71;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .market-btn {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-left: 10px;
        }
        
        .market-btn:hover:not(:disabled) {
            background: var(--accent);
            color: var(--bg-color);
        }
        
        .market-btn:disabled {
            border-color: #666;
            color: #666;
            cursor: not-allowed;
        }
        
        .market-btn.equipped {
            background: var(--accent);
            color: var(--bg-color);
            border-color: var(--accent);
        }
        
        .market-preview {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .preview-block {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        
        /* SatÄ±n alma onay modalÄ± */
        .purchase-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .purchase-content {
            background: var(--grid-bg);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--accent);
            max-width: 350px;
            text-align: center;
        }
        
        .purchase-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .preview-area {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            gap: 10px;
        }
        
        /* Ä°ptal butonu iÃ§in yeni stil */
        .cancel-btn {
            background: transparent;
            border: 2px solid var(--danger);
            color: var(--danger);
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-left: 10px;
            font-size: 0.8rem;
        }
        
        .cancel-btn:hover {
            background: var(--danger);
            color: var(--bg-color);
        }
        
        /* MÃ¼zik kontrol butonu */
        .music-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.5);
            border: 2px solid var(--accent);
            color: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            font-size: 1.5rem;
            transition: 0.3s;
        }
        
        .music-toggle-btn:hover {
            background: var(--accent);
            color: var(--bg-color);
            transform: scale(1.1);
        }
        
        .music-toggle-btn.muted {
            color: #666;
            border-color: #666;
        }
    </style>
</head>
<body class="theme-dark">

    <div id="bloodOverlay"></div>
    
    <!-- MÃ¼zik kontrol butonu -->
    <div class="music-toggle-btn" id="musicToggleBtn" onclick="game.toggleMusic()">â™ª</div>
    
    <!-- Yer kalmadÄ± timer - DÃœZELTÄ°LDÄ° -->
    <div id="noSpaceTimer" class="no-space-timer">
        <div style="font-size: 0.9rem; margin-bottom: 5px;">YER KALMADI!</div>
        <div style="font-size: 1.4rem; font-weight: bold;">KALAN SÃœRE: <span id="noSpaceTime">10</span>s</div>
    </div>
    
    <!-- Oyun iÃ§i uyarÄ± mesajÄ± -->
    <div id="gameAlert" class="game-alert">
        <div id="alertText"></div>
        <div class="alert-buttons" id="alertButtons"></div>
    </div>
    
    <!-- SatÄ±n alma onay modalÄ± -->
    <div id="purchaseModal" class="purchase-modal">
        <div class="purchase-content">
            <h3 style="color:var(--accent); margin-top:0">SATIN ALMAYI ONAYLA</h3>
            <p id="purchaseText">Bu Ã¼rÃ¼nÃ¼ satÄ±n almak istediÄŸinizden emin misiniz?</p>
            <div class="preview-area" id="purchasePreview"></div>
            <p style="color:var(--gold); font-weight:bold; font-size:1.2rem;" id="purchasePrice">1500 AltÄ±n</p>
            <div class="purchase-buttons">
                <button class="market-btn" onclick="game.confirmPurchase(true)">EVET, SATIN AL</button>
                <button class="market-btn" onclick="game.confirmPurchase(false)" style="border-color:var(--danger); color:var(--danger)">VAZGEÃ‡</button>
            </div>
        </div>
    </div>

    <div id="loader">
        <div style="width:50px; height:50px; border:5px solid var(--grid-bg); border-top-color:var(--accent); border-radius:50%; animation:heavyPulse 1s infinite"></div>
        <p style="margin-top:20px; color:var(--accent); letter-spacing: 2px;">MOMMY SUNUCUYA BAÄžLANIYOR...</p>
    </div>

    <div id="screenMenu" class="screen hidden">
        <h1 style="color:var(--accent); font-size: 4.5rem; text-shadow: 0 0 25px var(--accent); margin-bottom: 30px;">MOMMY</h1>
        <button class="menu-btn" onclick="game.uiShowPlayMode()">OYNA</button>
        <button class="menu-btn" onclick="game.uiShowMarket()">MARKET</button>
        <button class="menu-btn" onclick="game.uiShowSettings()">AYARLAR</button>
    </div>

    <div id="screenPlayMode" class="screen hidden">
        <h2 style="color:var(--accent); margin-bottom: 30px;">OYUN MODU</h2>
        <button class="menu-btn" onclick="game.showModSelection()">TEK OYUNCULU</button>
        <button class="menu-btn" onclick="game.uiShowMpHub()">Ã‡OK OYUNCULU</button>
        <button class="menu-btn" onclick="game.uiShowMenu()" style="border-color:var(--text-secondary); color:var(--text-secondary)">GERÄ°</button>
    </div>

    <div id="screenMarket" class="screen hidden">
        <h2 style="color:var(--gold); margin-bottom: 20px;">MARKET</h2>
        <div class="market-container">
            <div class="market-category">
                <h3>BLOK SKÄ°NLERÄ°</h3>
                <div class="market-item" data-type="block" data-id="default">
                    <div class="market-item-info">
                        <div class="market-item-name">ORJÄ°NAL</div>
                        <div class="market-item-desc">Standart blok gÃ¶rÃ¼nÃ¼mÃ¼</div>
                        <div class="market-preview">
                            <div class="preview-block" style="background:#f39c12"></div>
                            <div class="preview-block" style="background:#e74c3c"></div>
                            <div class="preview-block" style="background:#8e44ad"></div>
                        </div>
                    </div>
                    <div class="market-item-price">0 G</div>
                    <button class="market-btn equipped" onclick="game.equipSkin('block', 'default')">AKTÄ°F</button>
                </div>
                
                <div class="market-item" data-type="block" data-id="nature">
                    <div class="market-item-info">
                        <div class="market-item-name">DOÄžA</div>
                        <div class="market-item-desc">Toprak, tahta, yaprak temalÄ±</div>
                        <div class="market-preview">
                            <div class="preview-block" style="background:#8B4513"></div>
                            <div class="preview-block" style="background:#A0522D"></div>
                            <div class="preview-block" style="background:#228B22"></div>
                        </div>
                    </div>
                    <div class="market-item-price">1500 G</div>
                    <div id="natureStatus"></div>
                    <button class="market-btn" onclick="game.buyItem('block', 'nature', 1500)" id="natureBtn">SATIN AL</button>
                </div>
                
                <div class="market-item" data-type="block" data-id="gems">
                    <div class="market-item-info">
                        <div class="market-item-name">CEVHERLER</div>
                        <div class="market-item-desc">Ã–zel maden tasarÄ±mlÄ± (Elmas, ZÃ¼mrÃ¼t, Yakut)</div>
                        <div class="market-preview">
                            <div class="preview-block diamond"></div>
                            <div class="preview-block emerald"></div>
                            <div class="preview-block ruby"></div>
                        </div>
                    </div>
                    <div class="market-item-price">3000 G</div>
                    <div id="gemsStatus"></div>
                    <button class="market-btn" onclick="game.buyItem('block', 'gems', 3000)" id="gemsBtn">SATIN AL</button>
                </div>
                
                <div class="market-item" data-type="block" data-id="crystal">
                    <div class="market-item-info">
                        <div class="market-item-name">KRÄ°STAL</div>
                        <div class="market-item-desc">Parlak kristal efektli ve madenli</div>
                        <div class="market-preview">
                            <div class="preview-block sapphire"></div>
                            <div class="preview-block amber"></div>
                            <div class="preview-block" style="background:#00FFFF"></div>
                        </div>
                    </div>
                    <div class="market-item-price">6000 G</div>
                    <div id="crystalStatus"></div>
                    <button class="market-btn" onclick="game.buyItem('block', 'crystal', 6000)" id="crystalBtn">SATIN AL</button>
                </div>
            </div>
            
            <div class="market-category">
                <h3>ANÄ°MASYON SKÄ°NLERÄ°</h3>
                <div class="market-item" data-type="animation" data-id="default">
                    <div class="market-item-info">
                        <div class="market-item-name">STANDART</div>
                        <div class="market-item-desc">Normal animasyon efekti</div>
                    </div>
                    <div class="market-item-price">0 G</div>
                    <button class="market-btn equipped" onclick="game.equipSkin('animation', 'default')">AKTÄ°F</button>
                </div>
                
                <div class="market-item" data-type="animation" data-id="cute">
                    <div class="market-item-info">
                        <div class="market-item-name">TATLI</div>
                        <div class="market-item-desc">Sevimli efektler ve parlaklÄ±k</div>
                    </div>
                    <div class="market-item-price">1500 G</div>
                    <div id="cuteAnimStatus"></div>
                    <button class="market-btn" onclick="game.buyItem('animation', 'cute', 1500)" id="cuteAnimBtn">SATIN AL</button>
                </div>
                
                <div class="market-item" data-type="animation" data-id="epic">
                    <div class="market-item-info">
                        <div class="market-item-name">EPÄ°K</div>
                        <div class="market-item-desc">MuhteÅŸem efektler ve patlamalar</div>
                    </div>
                    <div class="market-item-price">3000 G</div>
                    <div id="epicAnimStatus"></div>
                    <button class="market-btn" onclick="game.buyItem('animation', 'epic', 3000)" id="epicAnimBtn">SATIN AL</button>
                </div>
                
                <div class="market-item" data-type="animation" data-id="magic">
                    <div class="market-item-info">
                        <div class="market-item-name">BÃœYÃœLÃœ</div>
                        <div class="market-item-desc">Sihirli efektler ve Ä±ÅŸÄ±ltÄ±</div>
                    </div>
                    <div class="market-item-price">6000 G</div>
                    <div id="magicAnimStatus"></div>
                    <button class="market-btn" onclick="game.buyItem('animation', 'magic', 6000)" id="magicAnimBtn">SATIN AL</button>
                </div>
            </div>
        </div>
        <button class="menu-btn" onclick="game.uiShowMenu()" style="margin-top:20px; border-color:var(--text-secondary); color:var(--text-secondary)">GERÄ°</button>
    </div>

    <div id="screenMpHub" class="screen hidden">
        <h2 style="color:var(--accent); margin-bottom: 20px;">Ã‡OK OYUNCULU</h2>
        <div class="mp-container">
            <p id="connStatus" style="font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 5px; text-align: center;">ID ALINIYOR...</p>
            <div id="myIdDisplay" class="id-badge" onclick="game.copyMyId()">---</div>
            
            <p style="font-size:0.8rem; color:var(--text-secondary); text-align:center; margin:10px 0;">Ä°lk kim ID girerse oda otomatik oluÅŸturulur!</p>
            
            <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
            <input type="text" id="roomInput" placeholder="ARKADAÅžININ ID'SÄ°NÄ° GÄ°R">
            <button class="menu-btn" id="joinBtn" style="width:100%; margin: 0;" onclick="game.mpJoinRoom()" disabled>ODAYA KATIL</button>
            <!-- Ä°ptal butonu eklendi -->
            <button class="cancel-btn" id="cancelBtn" style="width:100%; margin-top:10px; display:none;" onclick="game.mpCancelConnection()">BAÄžLANTIYI Ä°PTAL ET</button>
            <div id="connectingMsg" class="connecting-msg hidden"></div>
        </div>
        <button class="menu-btn" onclick="game.uiShowMenu()" style="margin-top:20px; border-color:var(--text-secondary); color:var(--text-secondary)">GERÄ°</button>
    </div>

    <div id="screenMpLobby" class="screen hidden">
        <h2 style="color:var(--gold); margin-bottom: 10px;">ODA LOBÄ°SÄ°</h2>
        <div id="lobbyIdDisplay" style="color:var(--accent); font-weight:bold; margin-bottom:20px; font-size:0.9rem; text-transform: uppercase;">ODA ID: ---</div>
        
        <div class="mp-container">
            <div id="playerList">
                <div class="player-tag"><span>SÄ°Z (HOST)</span></div>
            </div>
            
            <div id="hostControls" style="margin-top:20px;">
                <label style="font-size:0.7rem;">OYUN MODU SEÃ‡Ä°N</label>
                <select id="mpModeSelect" style="width:100%; background:#000; color:#fff; border:1px solid var(--accent); padding:8px; border-radius:5px; margin:10px 0;">
                    <option value="normal">NORMAL MOD</option>
                    <option value="timed">SÃœRELÄ° MOD</option>
                </select>
                <button class="menu-btn" id="mpStartBtn" style="width:100%; margin:0;" disabled onclick="game.mpStartMatch()">MAÃ‡I BAÅžLAT</button>
            </div>
            <p id="guestWaitMsg" class="hidden" style="font-size:0.8rem; color:var(--text-secondary); text-align:center;">Hostun oyunu baÅŸlatmasÄ± bekleniyor...</p>
        </div>
        <button class="menu-btn" onclick="game.mpLeaveRoom()" style="margin-top:20px; border-color:var(--danger); color:var(--danger)">AYRIL</button>
    </div>

    <div id="screenMods" class="screen hidden">
        <h2 style="color:var(--accent); margin-bottom: 30px;">TEK OYUNCULU</h2>
        <button class="menu-btn" onclick="game.start('normal')">NORMAL MOD<span style="font-size:0.7rem; opacity:0.6">REKOR: <span id="recordNormal">0</span></span></button>
        <button class="menu-btn" onclick="game.start('timed')">SÃœRELÄ° MOD<span style="font-size:0.7rem; opacity:0.6">REKOR: <span id="recordTimed">0</span></span></button>
        <button class="menu-btn" onclick="game.uiShowMenu()" style="border-color:var(--text-secondary); color:var(--text-secondary)">GERÄ°</button>
    </div>

    <div id="screenSettings" class="screen hidden">
        <div style="background:var(--grid-bg); padding:30px; border-radius:15px; width:320px; border:1px solid var(--accent-dim)">
            <h2 style="color:var(--accent); margin-top:0">AYARLAR</h2>
            <label>MÃ¼zik Sesi</label>
            <input type="range" id="volMusic" min="0" max="1" step="0.1" style="width:100%; margin: 10px 0 20px 0" oninput="game.updateMusicVolume(this.value)">
            <label>Efekt Sesi</label>
            <input type="range" id="volSfx" min="0" max="1" step="0.1" style="width:100%; margin: 10px 0 20px 0" oninput="game.updateSfxVolume(this.value)">
            
            <label style="margin-top: 20px; display: block;">TEMA SEÃ‡Ä°N</label>
            <div style="display: flex; gap: 10px; margin: 10px 0 20px 0;">
                <button class="theme-btn" onclick="game.changeTheme('dark')" style="background: #0b0c10; color: #ff007f; padding: 10px; border-radius: 8px; border: 2px solid #ff007f; flex: 1; cursor: pointer;">SÄ°YAH</button>
                <button class="theme-btn" onclick="game.changeTheme('purple')" style="background: #1a0b2e; color: #9d4edd; padding: 10px; border-radius: 8px; border: 2px solid #9d4edd; flex: 1; cursor: pointer;">MOR</button>
                <button class="theme-btn" onclick="game.changeTheme('turquoise')" style="background: #0d1b2a; color: #06d6a0; padding: 10px; border-radius: 8px; border: 2px solid #06d6a0; flex: 1; cursor: pointer;">TURKUAZ</button>
            </div>
            
            <button class="menu-btn" onclick="game.uiShowMenu()" style="width:100%; margin:0">GERÄ° DÃ–N</button>
        </div>
    </div>

    <div class="header" id="gameHUD" style="display:none">
        <div class="nav-btns">
            <button class="exit-btn" onclick="game.uiShowMenu()">MENÃœ</button>
            <button class="exit-btn" id="resetBtn" style="border-color:var(--gold); color:var(--gold)" onclick="game.reset()">TEKRAR</button>
        </div>
        <div class="hud-item" style="align-items: center;">
            <span style="font-size:0.6rem; color:var(--text-secondary)">SKOR</span>
            <span id="scoreTxt" style="font-weight:800; font-size:1.2rem">0</span>
        </div>
        <div class="hud-item" style="align-items: flex-end;">
            <span style="font-size:0.6rem; color:var(--text-secondary)">ALTIN</span>
            <span id="goldTxt" style="font-weight:800; color:var(--gold); font-size:1.2rem">0</span>
        </div>
    </div>

    <!-- VS TABLOSU -->
    <div class="mp-hud hidden" id="mpHUD">
        <div>SÄ°Z: <span id="myMpStatus" class="status-dot status-alive"></span> <span id="myMpScore">0</span></div>
        <div style="color:var(--accent); font-weight:bold;">VS</div>
        <div>RAKÄ°P: <span id="oppMpStatus" class="status-dot status-alive"></span> <span id="oppMpScore">0</span></div>
    </div>

    <div class="timer-container" id="timerBox" style="display:none">
        <div id="timerBar" class="timer-bar"></div>
        <div id="timerVal" class="timer-text">25.0s</div>
    </div>

    <div id="gameBody" class="game-area">
        <div class="grid" id="grid"></div>
        <div class="powerup-bar">
            <button class="pwr-btn" id="pwr-single" onclick="game.togglePwr('single')">TEK SÄ°L<br>150 G</button>
            <button class="pwr-btn" id="pwr-cross" onclick="game.togglePwr('cross')">+ SÄ°L<br>500 G</button>
            <button class="pwr-btn" id="pwr-nuke" onclick="game.togglePwr('nuke')">TEMÄ°ZLE<br>1000 G</button>
        </div>
        <div class="dock">
            <div class="slot" id="slot0" onmousedown="game.handleGrab(event,0)" ontouchstart="game.handleGrab(event,0)"></div>
            <div class="slot" id="slot1" onmousedown="game.handleGrab(event,1)" ontouchstart="game.handleGrab(event,1)"></div>
            <div class="slot" id="slot2" onmousedown="game.handleGrab(event,2)" ontouchstart="game.handleGrab(event,2)"></div>
        </div>
    </div>

    <div id="overlay" class="overlay">
        <h2 id="overTitle" style="color:var(--danger); font-size: 3.5rem; margin:0; text-shadow: 0 0 20px var(--danger);">OYUN BÄ°TTÄ°</h2>
        <p id="finalScore" style="font-size: 1.6rem; margin: 15px 0;">SKOR: 0</p>
        <p id="mpStats" style="font-size: 1rem; color: var(--gold); text-align:center;"></p>
        <div id="gameOverBtns">
            <button class="menu-btn" id="retryBtn" onclick="game.reset()">YENÄ°DEN DENE</button>
            <button class="menu-btn" onclick="game.uiShowMenu()" style="border-color:var(--text-secondary); color:var(--text-secondary)">ANA MENÃœ</button>
        </div>
    </div>

    <script>
        const Sound = {
            music: new Audio(), volM: 0.5, volS: 0.5,
            tracks: { 
                menu: "https://raw.githubusercontent.com/rominiarion/Test/main/1.mp3", 
                game: "https://raw.githubusercontent.com/rominiarion/Test/main/2.mp3",
                timed: "https://raw.githubusercontent.com/rominiarion/Test/main/3.mp3"
            },
            async load() {
                try {
                    console.log("MÃ¼zik dosyalarÄ± yÃ¼kleniyor...");
                    
                    const checkPromises = Object.values(this.tracks).map(url => 
                        fetch(url, { method: 'HEAD' }).catch(() => null)
                    );
                    
                    await Promise.all(checkPromises);
                    console.log("MÃ¼zik dosyalarÄ± hazÄ±r");
                    
                    this.music = new Audio();
                    this.music.preload = 'auto';
                    this.music.volume = this.volM;
                    this.music.loop = true;
                    
                    game.initAudio();
                } catch(e) { 
                    console.log("MÃ¼zik yÃ¼kleme hatasÄ±, devam ediliyor:", e);
                    game.initAudio(); 
                }
            },
            play(key) {
                console.log("MÃ¼zik Ã§alma Ã§aÄŸrÄ±ldÄ±:", key);
                
                // EÄŸer mÃ¼zik kapalÄ±ysa hiÃ§ baÅŸlatma
                if (this.volM <= 0) {
                    console.log("MÃ¼zik sesi kapalÄ±");
                    this.music.pause();
                    return;
                }
                
                const targetSrc = this.tracks[key];
                if (!targetSrc) {
                    console.log("MÃ¼zik URL bulunamadÄ±:", key);
                    return;
                }
                
                // EÄŸer aynÄ± mÃ¼zik Ã§alÄ±yorsa devam et
                if (this.music.src === targetSrc && !this.music.paused) {
                    console.log("AynÄ± mÃ¼zik zaten Ã§alÄ±yor");
                    return;
                }
                
                try {
                    console.log("MÃ¼zik baÅŸlatÄ±lÄ±yor:", key);
                    this.music.pause(); 
                    this.music.src = targetSrc;
                    this.music.volume = this.volM; 
                    this.music.loop = true;
                    
                    const playPromise = this.music.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log("MÃ¼zik baÅŸarÄ±yla baÅŸlatÄ±ldÄ±");
                        }).catch(error => {
                            console.log("MÃ¼zik baÅŸlatma hatasÄ±:", error);
                            // KullanÄ±cÄ± etkileÅŸimi bekleyerek tekrar dene
                            document.addEventListener('click', function tryPlayOnce() {
                                Sound.music.play().then(() => {
                                    console.log("KullanÄ±cÄ± etkileÅŸimi sonrasÄ± mÃ¼zik baÅŸlatÄ±ldÄ±");
                                }).catch(e => console.log("Tekrar deneme baÅŸarÄ±sÄ±z"));
                                document.removeEventListener('click', tryPlayOnce);
                            }, { once: true });
                        });
                    }
                } catch(e) {
                    console.log("MÃ¼zik baÅŸlatma hatasÄ±:", e);
                }
            },
            stop() {
                console.log("MÃ¼zik durduruluyor");
                this.music.pause();
                this.music.currentTime = 0;
            },
            sfx(f1, f2) {
                if (this.volS <= 0) return;
                
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const o = ctx.createOscillator(), g = ctx.createGain();
                    o.frequency.setValueAtTime(f1, ctx.currentTime);
                    if(f2) o.frequency.exponentialRampToValueAtTime(f2, ctx.currentTime+0.1);
                    g.gain.setValueAtTime(this.volS*0.1, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.1);
                    o.connect(g); g.connect(ctx.destination);
                    o.start(); o.stop(ctx.currentTime+0.1);
                } catch(e){}
            }
        };

        // Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ deÄŸiÅŸtiÄŸinde mÃ¼ziÄŸi kontrol et
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log("Sayfa gizlendi, mÃ¼zik durduruluyor");
                Sound.music.pause();
            } else {
                console.log("Sayfa gÃ¶rÃ¼nÃ¼r oldu, mÃ¼zik kontrol ediliyor");
                // MÃ¼zik aÃ§Ä±ksa devam ettir
                if (Sound.volM > 0 && Sound.music.src) {
                    setTimeout(() => {
                        if (Sound.music.paused) {
                            Sound.music.play().catch(e => console.log("MÃ¼zik devam ettirilemedi:", e));
                        }
                    }, 300);
                }
            }
        });

        class Game {
            constructor() {
                this.save = JSON.parse(localStorage.getItem('mommy_v8')) || { 
                    gold: 0, 
                    normal: 0, 
                    timed: 0, 
                    volM: 0.5, 
                    volS: 0.5,
                    theme: 'dark',
                    ownedSkins: {
                        block: ['default'],
                        animation: ['default']
                    },
                    equippedSkin: {
                        block: 'default',
                        animation: 'default'
                    },
                    musicEnabled: true
                };
                
                if (!this.save.ownedSkins) {
                    this.save.ownedSkins = {
                        block: ['default'],
                        animation: ['default']
                    };
                }
                if (!this.save.equippedSkin) {
                    this.save.equippedSkin = {
                        block: 'default',
                        animation: 'default'
                    };
                }
                if (!this.save.theme) {
                    this.save.theme = 'dark';
                }
                if (this.save.musicEnabled === undefined) {
                    this.save.musicEnabled = true;
                }
                
                document.body.className = 'theme-' + this.save.theme;
                
                Sound.volM = this.save.volM;
                Sound.volS = this.save.volS;
                
                this.grid = Array(8).fill().map(() => Array(8).fill(null));
                this.score = 0; 
                this.timer = { 
                    current: 25, 
                    max: 25, 
                    active: false, 
                    startTime: 0, 
                    finishTime: 0,
                    paused: false
                };
                this.currentShapes = [null,null,null]; 
                this.gridEl = document.getElementById('grid');
                this.activePwr = null; 
                this.gameOverTriggered = false;
                this.peer = null; 
                this.conn = null; 
                this.myId = null;
                this.isHost = false; 
                this.isMp = false;
                this.oppScore = 0; 
                this.oppAlive = true; 
                this.oppFinishTime = 0;
                this.currentMode = 'normal';
                this.lastTickTime = 0;
                this.noSpaceTimer = 10;
                this.noSpaceTimerActive = false;
                this.noSpaceTimerInterval = null;
                this.mpSyncInterval = null;
                this.isInGame = false;
                this.pendingPurchase = null;
                this.currentAnimation = 'default';
                this.connectionTimeout = null;
                
                this.init();
            }

            init() {
                Sound.load(); 
                this.renderGrid(); 
                this.updateUI();
                
                const tick = (timestamp) => {
                    if (!this.lastTickTime) this.lastTickTime = timestamp;
                    const delta = timestamp - this.lastTickTime;
                    
                    if (delta >= 100) {
                        this.tick();
                        this.lastTickTime = timestamp;
                    }
                    requestAnimationFrame(tick);
                };
                requestAnimationFrame(tick);
                
                setTimeout(() => { 
                    if(this.gridEl.children.length > 0) { 
                        this.cellSize = this.gridEl.children[0].offsetWidth; 
                        document.documentElement.style.setProperty('--drag-size', this.cellSize + 'px'); 
                    } 
                }, 1000);
                
                this.connectToPeer();
                
                this.loadSettingsUI();
                this.updateMarketUI();
                this.preventLandscape();
                this.updateMusicButton();
            }

            // YENÄ°: MenÃ¼ mÃ¼ziÄŸini baÅŸlat
            startMenuMusic() {
                if (this.save.musicEnabled && Sound.volM > 0) {
                    console.log("MenÃ¼ mÃ¼ziÄŸi baÅŸlatÄ±lÄ±yor");
                    Sound.play('menu');
                }
            }

            toggleMusic() {
                this.save.musicEnabled = !this.save.musicEnabled;
                this.syncSave();
                
                if (this.save.musicEnabled) {
                    Sound.volM = this.save.volM;
                    // EÄŸer menÃ¼deysek menÃ¼ mÃ¼ziÄŸini baÅŸlat
                    if (!this.isInGame) {
                        this.startMenuMusic();
                    } else {
                        // Oyun iÃ§indeysek oyun mÃ¼ziÄŸini baÅŸlat
                        Sound.play(this.currentMode === 'timed' ? 'timed' : 'game');
                    }
                } else {
                    Sound.volM = 0;
                    Sound.stop();
                }
                
                this.updateMusicButton();
                Sound.music.volume = Sound.volM;
            }

            updateMusicButton() {
                const btn = document.getElementById('musicToggleBtn');
                if (btn) {
                    if (this.save.musicEnabled) {
                        btn.textContent = 'â™ª';
                        btn.classList.remove('muted');
                    } else {
                        btn.textContent = 'ðŸ”‡';
                        btn.classList.add('muted');
                    }
                }
            }

            changeTheme(theme) {
                this.save.theme = theme;
                document.body.className = 'theme-' + theme;
                this.syncSave();
                
                if (this.isInGame) {
                    this.refreshGrid();
                }
            }

            preventLandscape() {
                const lockOrientation = () => {
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock('portrait').catch(() => {
                            console.log("Orientasyon kilitlenemedi");
                        });
                    }
                };
                
                window.addEventListener('load', lockOrientation);
                window.addEventListener('orientationchange', () => {
                    if (window.orientation === 90 || window.orientation === -90) {
                        this.showGameAlert("LÃ¼tfen cihazÄ±nÄ±zÄ± dikey moda getirin!");
                    }
                });
            }

            showGameAlert(message, buttons = []) {
                document.getElementById('alertText').textContent = message;
                const buttonsDiv = document.getElementById('alertButtons');
                buttonsDiv.innerHTML = '';
                
                if (buttons.length === 0) {
                    buttonsDiv.innerHTML = '<button class="alert-btn" onclick="document.getElementById(\'gameAlert\').style.display=\'none\'">TAMAM</button>';
                } else {
                    buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.className = 'alert-btn';
                        button.textContent = btn.text;
                        button.onclick = btn.action;
                        buttonsDiv.appendChild(button);
                    });
                }
                
                document.getElementById('gameAlert').style.display = 'flex';
            }

            loadSettingsUI() {
                setTimeout(() => {
                    const musicSlider = document.getElementById('volMusic');
                    const sfxSlider = document.getElementById('volSfx');
                    if (musicSlider) {
                        musicSlider.value = Sound.volM;
                        musicSlider.oninput = (e) => this.updateMusicVolume(e.target.value);
                    }
                    if (sfxSlider) {
                        sfxSlider.value = Sound.volS;
                        sfxSlider.oninput = (e) => this.updateSfxVolume(e.target.value);
                    }
                }, 100);
            }

            updateMusicVolume(value) {
                Sound.volM = parseFloat(value);
                this.save.volM = Sound.volM;
                
                // EÄŸer mÃ¼zik kapalÄ±ysa ve ses aÃ§Ä±lÄ±yorsa, mÃ¼ziÄŸi aÃ§
                if (Sound.volM > 0 && !this.save.musicEnabled) {
                    this.save.musicEnabled = true;
                    this.updateMusicButton();
                }
                
                Sound.music.volume = Sound.volM;
                this.syncSave();
                
                // EÄŸer menÃ¼deysek menÃ¼ mÃ¼ziÄŸini baÅŸlat
                if (!this.isInGame && this.save.musicEnabled && Sound.volM > 0) {
                    this.startMenuMusic();
                } else if (this.isInGame && Sound.volM > 0 && Sound.music.paused) {
                    // Oyun iÃ§indeysek oyun mÃ¼ziÄŸini baÅŸlat
                    Sound.play(this.currentMode === 'timed' ? 'timed' : 'game');
                }
            }

            updateSfxVolume(value) {
                Sound.volS = parseFloat(value);
                this.save.volS = Sound.volS;
                this.syncSave();
            }

            updateMarketUI() {
                const skins = ['nature', 'gems', 'crystal'];
                skins.forEach(skin => {
                    const owned = this.save.ownedSkins.block.includes(skin);
                    const equipped = this.save.equippedSkin.block === skin;
                    
                    const statusDiv = document.getElementById(`${skin}Status`);
                    const button = document.getElementById(`${skin}Btn`);
                    
                    if (statusDiv && button) {
                        if (owned) {
                            statusDiv.innerHTML = `<span class="market-item-owned">SAHÄ°P</span>`;
                            button.textContent = equipped ? 'AKTÄ°F' : 'KULLAN';
                            button.onclick = () => this.equipSkin('block', skin);
                            button.className = equipped ? 'market-btn equipped' : 'market-btn';
                        } else {
                            statusDiv.innerHTML = '';
                            button.textContent = 'SATIN AL';
                            button.onclick = () => this.buyItem('block', skin, 
                                skin === 'nature' ? 1500 : skin === 'gems' ? 3000 : 6000);
                            button.className = 'market-btn';
                        }
                    }
                });
                
                const anims = ['cute', 'epic', 'magic'];
                anims.forEach(anim => {
                    const owned = this.save.ownedSkins.animation.includes(anim);
                    const equipped = this.save.equippedSkin.animation === anim;
                    
                    const statusDiv = document.getElementById(`${anim}AnimStatus`);
                    const button = document.getElementById(`${anim}AnimBtn`);
                    
                    if (statusDiv && button) {
                        if (owned) {
                            statusDiv.innerHTML = `<span class="market-item-owned">SAHÄ°P</span>`;
                            button.textContent = equipped ? 'AKTÄ°F' : 'KULLAN';
                            button.onclick = () => this.equipSkin('animation', anim);
                            button.className = equipped ? 'market-btn equipped' : 'market-btn';
                        } else {
                            statusDiv.innerHTML = '';
                            button.textContent = 'SATIN AL';
                            button.onclick = () => this.buyItem('animation', anim, 
                                anim === 'cute' ? 1500 : anim === 'epic' ? 3000 : 6000);
                            button.className = 'market-btn';
                        }
                    }
                });
            }

            buyItem(type, id, price) {
                this.pendingPurchase = { type, id, price };
                
                let itemName = '';
                let previewColors = [];
                
                if (type === 'block') {
                    if (id === 'nature') {
                        itemName = 'DoÄŸa Blok Skin Paketi';
                        previewColors = ['#8B4513', '#A0522D', '#228B22'];
                    } else if (id === 'gems') {
                        itemName = 'Cevher Blok Skin Paketi';
                        previewColors = ['#FFD700', '#C0C0C0', '#B9F2FF'];
                    } else if (id === 'crystal') {
                        itemName = 'Kristal Blok Skin Paketi';
                        previewColors = ['#00FFFF', '#FF00FF', '#FFFF00'];
                    }
                } else if (type === 'animation') {
                    if (id === 'cute') {
                        itemName = 'TatlÄ± Animasyon Paketi';
                    } else if (id === 'epic') {
                        itemName = 'Epik Animasyon Paketi';
                    } else if (id === 'magic') {
                        itemName = 'BÃ¼yÃ¼lÃ¼ Animasyon Paketi';
                    }
                }
                
                document.getElementById('purchaseText').textContent = `${itemName} satÄ±n almak istediÄŸinizden emin misiniz?`;
                document.getElementById('purchasePrice').textContent = `${price} AltÄ±n`;
                
                const previewDiv = document.getElementById('purchasePreview');
                previewDiv.innerHTML = '';
                
                if (type === 'block') {
                    previewColors.forEach(color => {
                        const block = document.createElement('div');
                        block.className = 'preview-block';
                        block.style.background = color;
                        previewDiv.appendChild(block);
                    });
                } else {
                    const text = document.createElement('div');
                    if (id === 'cute') text.textContent = 'â¤ï¸ Kalpler ve YÄ±ldÄ±zlar â¤ï¸';
                    else if (id === 'epic') text.textContent = 'ðŸ’¥ Patlamalar ve IÅŸÄ±klar ðŸ’¥';
                    else text.textContent = 'âœ¨ Sihirli IÅŸÄ±ltÄ±lar âœ¨';
                    text.style.color = 'var(--text-secondary)';
                    previewDiv.appendChild(text);
                }
                
                document.getElementById('purchaseModal').style.display = 'flex';
            }

            confirmPurchase(confirmed) {
                document.getElementById('purchaseModal').style.display = 'none';
                
                if (confirmed && this.pendingPurchase) {
                    const { type, id, price } = this.pendingPurchase;
                    
                    if (this.save.gold >= price) {
                        this.save.gold -= price;
                        
                        if (!this.save.ownedSkins[type].includes(id)) {
                            this.save.ownedSkins[type].push(id);
                        }
                        
                        this.save.equippedSkin[type] = id;
                        
                        this.syncSave();
                        this.updateUI();
                        this.updateMarketUI();
                        
                        if (this.isInGame) {
                            if (type === 'block') {
                                this.applyCurrentSkins();
                            } else if (type === 'animation') {
                                this.currentAnimation = id;
                            }
                        }
                        
                        Sound.sfx(800, 1200);
                        this.showGameAlert('SatÄ±n alma baÅŸarÄ±lÄ±! Yeni skin aktif edildi.');
                    } else {
                        this.showGameAlert('Yeterli altÄ±nÄ±nÄ±z yok!');
                    }
                }
                
                this.pendingPurchase = null;
            }

            equipSkin(type, id) {
                if (this.save.ownedSkins[type].includes(id)) {
                    this.save.equippedSkin[type] = id;
                    this.syncSave();
                    this.updateMarketUI();
                    
                    if (this.isInGame) {
                        if (type === 'block') {
                            this.applyCurrentSkins();
                        } else if (type === 'animation') {
                            this.currentAnimation = id;
                        }
                    }
                    
                    Sound.sfx(600, 800);
                }
            }

            applyCurrentSkins() {
                const blockSkin = this.save.equippedSkin.block;
                let colorPalette = ['#f39c12', '#e74c3c', '#8e44ad', '#3498db', '#2ecc71'];
                
                if (blockSkin === 'nature') {
                    colorPalette = ['#8B4513', '#A0522D', '#228B22', '#D2691E', '#6B8E23'];
                } else if (blockSkin === 'gems') {
                    colorPalette = ['#FFD700', '#C0C0C0', '#B9F2FF', '#FF69B4', '#32CD32'];
                } else if (blockSkin === 'crystal') {
                    colorPalette = ['#00FFFF', '#FF00FF', '#FFFF00', '#FF4500', '#9370DB'];
                }
                
                this.currentShapes.forEach((shape, idx) => {
                    if (shape) {
                        shape.color = colorPalette[Math.floor(Math.random() * colorPalette.length)];
                        this.drawSlot(idx, shape.matrix, shape.color);
                    }
                });
                
                for(let r=0; r<8; r++) {
                    for(let c=0; c<8; c++) {
                        if(this.grid[r][c]) {
                            const oldColors = ['#f39c12', '#e74c3c', '#8e44ad', '#3498db', '#2ecc71'];
                            if(oldColors.includes(this.grid[r][c])) {
                                this.grid[r][c] = colorPalette[Math.floor(Math.random() * colorPalette.length)];
                            }
                        }
                    }
                }
                this.refreshGrid();
            }

            createParticle(type, x, y) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                if (type === 'heart') {
                    particle.className += ' heart-particle';
                    particle.innerHTML = 'â¤ï¸';
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                } else if (type === 'star') {
                    particle.className += ' star-particle';
                    particle.innerHTML = 'â­';
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                } else if (type === 'sparkle') {
                    particle.className += ' sparkle-particle';
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                }
                
                document.body.appendChild(particle);
                
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 1000);
            }

            applyAnimationEffect(type, x, y) {
                const animSkin = this.save.equippedSkin.animation;
                
                if (animSkin === 'cute') {
                    for(let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            this.createParticle('heart', x + Math.random() * 40 - 20, y + Math.random() * 40 - 20);
                            this.createParticle('star', x + Math.random() * 40 - 20, y + Math.random() * 40 - 20);
                        }, i * 100);
                    }
                    
                    document.querySelectorAll('.block').forEach(block => {
                        block.style.animation = 'cuteBounce 0.5s ease-in-out';
                        setTimeout(() => {
                            block.style.animation = '';
                        }, 500);
                    });
                    
                } else if (animSkin === 'epic') {
                    const explosion = document.createElement('div');
                    explosion.style.position = 'fixed';
                    explosion.style.left = x + 'px';
                    explosion.style.top = y + 'px';
                    explosion.style.width = '50px';
                    explosion.style.height = '50px';
                    explosion.style.background = 'radial-gradient(circle, #ff9900, #ff0000)';
                    explosion.style.borderRadius = '50%';
                    explosion.style.animation = 'epicExplosion 0.3s ease-out';
                    explosion.style.zIndex = '999';
                    document.body.appendChild(explosion);
                    
                    setTimeout(() => {
                        if (explosion.parentNode) {
                            explosion.parentNode.removeChild(explosion);
                        }
                    }, 300);
                    
                } else if (animSkin === 'magic') {
                    const cells = document.querySelectorAll('.cell:not(.empty)');
                    cells.forEach(cell => {
                        cell.style.animation = 'magicGlow 1s infinite';
                        setTimeout(() => {
                            cell.style.animation = '';
                        }, 1000);
                    });
                }
            }

            connectToPeer() {
                if(this.peer) try { this.peer.destroy(); } catch(e){}
                
                this.peer = new Peer({
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    secure: true,
                    config: { 
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' }
                        ] 
                    },
                    debug: 2
                });
                
                this.peer.on('open', id => { 
                    this.myId = id;
                    const badge = document.getElementById('myIdDisplay');
                    badge.innerText = id; 
                    badge.classList.add('ready');
                    document.getElementById('joinBtn').disabled = false;
                    document.getElementById('connStatus').innerText = "BAÄžLANTI HAZIR";
                    document.getElementById('connStatus').style.color = "#2ecc71";
                });
                
                this.peer.on('connection', c => {
                    console.log("Yeni baÄŸlantÄ± geldi:", c.peer);
                    if(this.conn && this.conn.open) { 
                        console.log("Zaten baÄŸlantÄ± var, yeni baÄŸlantÄ± reddedildi");
                        c.close(); 
                        return; 
                    } 
                    
                    if(this.conn) {
                        try {
                            this.conn.close();
                        } catch(e) {}
                        this.conn = null;
                    }
                    
                    this.conn = c; 
                    this.isHost = true;
                    this.setupConn();
                });
                
                this.peer.on('error', err => {
                    console.error("PeerJS HatasÄ±:", err);
                    document.getElementById('connStatus').innerText = "HATA: " + err.type.toUpperCase();
                    document.getElementById('connStatus').style.color = "var(--danger)";
                    
                    if(err.type === 'peer-unavailable') {
                        this.showGameAlert("Oda bulunamadÄ±! ID'yi kontrol edin.");
                    } else if(err.type === 'network') {
                        this.showGameAlert("AÄŸ hatasÄ±! Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.");
                    } else if(err.type === 'server-error') {
                        this.showGameAlert("Sunucu hatasÄ±! LÃ¼tfen tekrar deneyin.");
                    }
                });
                
                this.peer.on('disconnected', () => {
                    console.log("Peer baÄŸlantÄ±sÄ± kesildi, yeniden baÄŸlanÄ±lÄ±yor...");
                    this.peer.reconnect();
                });
                
                this.peer.on('close', () => {
                    console.log("Peer baÄŸlantÄ±sÄ± kapandÄ±");
                });
            }

            copyMyId() {
                if(!this.myId) return;
                const dummy = document.createElement("input");
                document.body.appendChild(dummy); dummy.value = this.myId; dummy.select();
                document.execCommand("copy"); document.body.removeChild(dummy);
                const b = document.getElementById('myIdDisplay'); const old = b.innerText;
                b.innerText = "KOPYALANDI!"; setTimeout(() => b.innerText = old, 1000);
            }

            setupConn() {
                if (!this.conn) return;
                
                this.conn.on('open', () => {
                    console.log("BaÄŸlantÄ± aÃ§Ä±ldÄ±!");
                    this.updateMpLobbyUI();
                });
                
                this.conn.on('data', data => {
                    console.log("Gelen veri:", data);
                    
                    if(data.type === 'kick') { 
                        this.showGameAlert("Odadan atÄ±ldÄ±nÄ±z!", [
                            { text: "TAMAM", action: () => location.reload() }
                        ]);
                    }
                    if(data.type === 'start') { 
                        this.isMp = true; 
                        this.start(data.mode); 
                    }
                    if(data.type === 'sync') { 
                        this.oppScore = data.score; 
                        this.oppAlive = data.alive; 
                        this.updateHUD();
                        this.updateMpHUD();
                    }
                    if(data.type === 'finish') { 
                        this.oppAlive = false; 
                        this.oppFinishTime = data.time; 
                        this.checkMatchEnd(); 
                    }
                });
                
                this.conn.on('close', () => { 
                    console.log("BaÄŸlantÄ± kapandÄ±");
                    if(this.isMp) { 
                        this.showGameAlert("Rakip ayrÄ±ldÄ±!", [
                            { text: "TAMAM", action: () => location.reload() }
                        ]);
                    } else if (this.conn && !this.isMp) {
                        this.showGameAlert("BaÄŸlantÄ± kesildi!", [
                            { text: "TAMAM", action: () => location.reload() }
                        ]);
                    }
                });
                
                this.conn.on('error', (err) => {
                    console.error("BaÄŸlantÄ± hatasÄ±:", err);
                    this.showGameAlert("BaÄŸlantÄ± hatasÄ± oluÅŸtu!");
                });
                
                this.updateMpLobbyUI();
            }
            
            mpCancelConnection() {
                if (this.connectionTimeout) {
                    clearTimeout(this.connectionTimeout);
                    this.connectionTimeout = null;
                }
                
                if (this.conn) {
                    try {
                        this.conn.close();
                    } catch(e) {}
                    this.conn = null;
                }
                
                document.getElementById('connectingMsg').classList.add('hidden');
                document.getElementById('connectingMsg').innerText = "";
                document.getElementById('joinBtn').disabled = false;
                document.getElementById('joinBtn').textContent = "ODAYA KATIL";
                document.getElementById('cancelBtn').style.display = 'none';
                
                this.showGameAlert("BaÄŸlantÄ± iptal edildi.");
            }
            
            updateMpHUD() {
                if (!this.isMp) return;
                
                const myScoreElem = document.getElementById('myMpScore');
                const oppScoreElem = document.getElementById('oppMpScore');
                const myStatusElem = document.getElementById('myMpStatus');
                const oppStatusElem = document.getElementById('oppMpStatus');
                
                if (myScoreElem) myScoreElem.textContent = this.score;
                if (oppScoreElem) oppScoreElem.textContent = this.oppScore;
                
                if (myStatusElem) {
                    myStatusElem.className = 'status-dot ' + 
                        (this.gameOverTriggered ? 'status-dead' : 'status-alive');
                }
                if (oppStatusElem) {
                    oppStatusElem.className = 'status-dot ' + 
                        (!this.oppAlive ? 'status-dead' : 'status-alive');
                }
                
                document.getElementById('mpHUD').classList.remove('hidden');
            }

            uiShowMarket() {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById('screenMarket').classList.remove('hidden');
                this.updateMarketUI();
            }

            mpJoinRoom() {
                const id = document.getElementById('roomInput').value.trim();
                if(!id || !this.myId) return;
                
                if (this.conn) {
                    try {
                        this.conn.close();
                    } catch(e) {}
                    this.conn = null;
                }
                
                document.getElementById('connectingMsg').innerText = "BaÄŸlanÄ±yor... (15 saniye iÃ§inde baÄŸlanamazsa iptal edin)";
                document.getElementById('connectingMsg').classList.remove('hidden');
                document.getElementById('joinBtn').disabled = true;
                document.getElementById('joinBtn').textContent = "BAÄžLANIYOR...";
                document.getElementById('cancelBtn').style.display = 'block';
                
                this.isHost = false;
                
                this.connectionTimeout = setTimeout(() => {
                    if (this.conn && !this.conn.open) {
                        this.mpCancelConnection();
                        this.showGameAlert("BaÄŸlantÄ± zaman aÅŸÄ±mÄ±na uÄŸradÄ±! LÃ¼tfen ID'yi kontrol edin.");
                    }
                }, 15000);
                
                try {
                    this.conn = this.peer.connect(id, { 
                        reliable: true,
                        serialization: 'json'
                    });
                    
                    if (!this.conn) {
                        throw new Error("BaÄŸlantÄ± oluÅŸturulamadÄ±");
                    }
                    
                    this.conn.on('open', () => {
                        console.log("BaÄŸlantÄ± baÅŸarÄ±lÄ±!");
                        if (this.connectionTimeout) {
                            clearTimeout(this.connectionTimeout);
                            this.connectionTimeout = null;
                        }
                        
                        document.getElementById('connectingMsg').innerText = "BaÄŸlantÄ± baÅŸarÄ±lÄ±!";
                        setTimeout(() => {
                            document.getElementById('connectingMsg').classList.add('hidden');
                            document.getElementById('cancelBtn').style.display = 'none';
                            this.setupConn();
                        }, 1000);
                    });
                    
                    this.conn.on('error', (err) => {
                        console.error("BaÄŸlantÄ± hatasÄ±:", err);
                        if (this.connectionTimeout) {
                            clearTimeout(this.connectionTimeout);
                            this.connectionTimeout = null;
                        }
                        
                        document.getElementById('connectingMsg').innerText = "BaÄŸlantÄ± hatasÄ±!";
                        document.getElementById('joinBtn').disabled = false;
                        document.getElementById('joinBtn').textContent = "ODAYA KATIL";
                        document.getElementById('cancelBtn').style.display = 'none';
                        
                        this.showGameAlert("BaÄŸlantÄ± hatasÄ±: " + err.message);
                    });
                    
                } catch (err) {
                    console.error("BaÄŸlantÄ± oluÅŸturma hatasÄ±:", err);
                    if (this.connectionTimeout) {
                        clearTimeout(this.connectionTimeout);
                        this.connectionTimeout = null;
                    }
                    
                    document.getElementById('connectingMsg').innerText = "BaÄŸlantÄ± hatasÄ±!";
                    document.getElementById('joinBtn').disabled = false;
                    document.getElementById('joinBtn').textContent = "ODAYA KATIL";
                    document.getElementById('cancelBtn').style.display = 'none';
                    
                    this.showGameAlert("BaÄŸlantÄ± oluÅŸturulamadÄ±: " + err.message);
                }
            }

            mpKick() { 
                if(this.conn) { 
                    this.conn.send({type:'kick'}); 
                    this.conn.close(); 
                    this.conn = null; 
                    this.updateMpLobbyUI(); 
                } 
            }
            
            mpLeaveRoom() { 
                if (this.mpSyncInterval) {
                    clearInterval(this.mpSyncInterval);
                    this.mpSyncInterval = null;
                }
                
                if (this.connectionTimeout) {
                    clearTimeout(this.connectionTimeout);
                    this.connectionTimeout = null;
                }
                
                if (this.conn) {
                    try {
                        this.conn.close();
                    } catch(e) {}
                    this.conn = null;
                }
                
                location.reload(); 
            }
            
            mpStartMatch() {
                if(!this.conn || !this.conn.open) {
                    this.showGameAlert("BaÄŸlantÄ± yok!");
                    return;
                }
                
                const mode = document.getElementById('mpModeSelect').value;
                
                setTimeout(() => {
                    if (this.conn && this.conn.open) {
                        this.conn.send({type: 'start', mode: mode});
                        this.isMp = true; 
                        this.start(mode);
                    } else {
                        this.showGameAlert("BaÄŸlantÄ± kesildi!");
                    }
                }, 500);
            }

            syncSave() { localStorage.setItem('mommy_v8', JSON.stringify(this.save)); }
            
            initAudio() { 
                document.getElementById('loader').classList.add('hidden'); 
                this.uiShowMenu(); 
                // MenÃ¼yÃ¼ gÃ¶sterdikten sonra menÃ¼ mÃ¼ziÄŸini baÅŸlat
                setTimeout(() => {
                    this.startMenuMusic();
                }, 500);
            }
            
            uiShowPlayMode() { 
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
                document.getElementById('screenPlayMode').classList.remove('hidden'); 
                // MenÃ¼ mÃ¼ziÄŸini devam ettir
                this.startMenuMusic();
            }
            
            uiShowMpHub() { 
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
                document.getElementById('screenMpHub').classList.remove('hidden'); 
                // MenÃ¼ mÃ¼ziÄŸini devam ettir
                this.startMenuMusic();
            }
            
            showModSelection() { 
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
                document.getElementById('screenMods').classList.remove('hidden'); 
                // MenÃ¼ mÃ¼ziÄŸini devam ettir
                this.startMenuMusic();
            }
            
            uiShowSettings() { 
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
                document.getElementById('screenSettings').classList.remove('hidden'); 
                // MenÃ¼ mÃ¼ziÄŸini devam ettir
                this.startMenuMusic();
            }
            
            uiShowMenu() { 
                this.isInGame = false;
                // MenÃ¼ye dÃ¶ndÃ¼ÄŸÃ¼mÃ¼zde menÃ¼ mÃ¼ziÄŸini baÅŸlat
                this.startMenuMusic();
                
                this.timer.active = false; 
                this.timer.paused = true;
                this.gameOverTriggered = false; 
                this.isMp = false;
                
                if (this.mpSyncInterval) {
                    clearInterval(this.mpSyncInterval);
                    this.mpSyncInterval = null;
                }
                
                if (this.connectionTimeout) {
                    clearTimeout(this.connectionTimeout);
                    this.connectionTimeout = null;
                }
                
                this.stopNoSpaceTimer();
                
                document.getElementById('timerBox').style.display = 'none';
                document.getElementById('gameHUD').style.display = 'none';
                document.getElementById('mpHUD').classList.add('hidden');
                document.getElementById('bloodOverlay').style.opacity = 0;
                document.getElementById('gameAlert').style.display = 'none';
                
                const gameBody = document.getElementById('gameBody');
                gameBody.classList.remove('pulse-soft', 'pulse-heavy');
                
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); 
                document.getElementById('screenMenu').classList.remove('hidden'); 
                document.getElementById('overlay').style.display = 'none';
                this.clearGhost(); 
                this.updateUI(); 
            }

            start(mode) {
                this.isInGame = true;
                this.currentAnimation = this.save.equippedSkin.animation;
                
                this.currentMode = mode; 
                this.score = 0; 
                this.grid = this.grid.map(r => r.fill(null));
                this.timer.max = 25; 
                this.timer.current = 25; 
                this.timer.active = (mode === 'timed');
                this.timer.startTime = Date.now(); 
                this.timer.paused = false;
                this.oppAlive = true; 
                this.oppScore = 0;
                this.gameOverTriggered = false; 
                this.activePwr = null;
                this.noSpaceTimer = 10;
                this.noSpaceTimerActive = false;
                
                if (this.isMp) {
                    this.updateMpHUD();
                }
                
                this.applyCurrentSkins();
                
                if (this.isMp && this.mpSyncInterval) {
                    clearInterval(this.mpSyncInterval);
                }
                
                document.getElementById('gameHUD').style.display = 'flex';
                document.getElementById('timerBox').style.display = (mode === 'timed' ? 'block' : 'none');
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('gameAlert').style.display = 'none';
                
                document.getElementById('noSpaceTimer').style.display = 'none';
                
                const gameBody = document.getElementById('gameBody');
                gameBody.classList.remove('pulse-soft', 'pulse-heavy');
                
                if(this.isMp) { 
                    document.getElementById('mpHUD').classList.remove('hidden'); 
                    document.getElementById('retryBtn').style.display = 'none'; 
                    document.getElementById('resetBtn').style.display = 'none'; 
                    
                    this.mpSyncInterval = setInterval(() => {
                        if (this.conn && this.conn.open) {
                            this.conn.send({type:'sync', score:this.score, alive:!this.gameOverTriggered});
                        }
                    }, 500);
                    
                    this.updateHUD(); 
                } else { 
                    document.getElementById('retryBtn').style.display = 'flex'; 
                    document.getElementById('resetBtn').style.display = 'flex'; 
                }
                
                // Oyun mÃ¼ziÄŸini baÅŸlat - menÃ¼ mÃ¼ziÄŸini durdurup oyun mÃ¼ziÄŸini baÅŸlat
                if (this.save.musicEnabled && Sound.volM > 0) {
                    Sound.play(mode === 'timed' ? 'timed' : 'game');
                }
                
                this.refreshGrid(); 
                this.updateUI(); 
                this.spawnShapes();
            }

            tick() {
                if(!this.timer.active || this.timer.paused) return;
                
                this.timer.current -= 0.1;
                const bar = document.getElementById('timerBar'), 
                      tVal = document.getElementById('timerVal'), 
                      blood = document.getElementById('bloodOverlay'), 
                      body = document.getElementById('gameBody');
                
                bar.style.width = (this.timer.current / this.timer.max * 100) + '%';
                tVal.innerText = Math.max(0, this.timer.current).toFixed(1) + "s";
                
                if(this.currentMode === 'timed') {
                    if(this.timer.current <= 15 && this.timer.current > 6) {
                        body.classList.add('pulse-soft');
                        body.classList.remove('pulse-heavy');
                        blood.style.opacity = 0;
                    }
                    else if(this.timer.current <= 6 && this.timer.current > 0) {
                        body.classList.remove('pulse-soft', 'pulse-heavy');
                        blood.style.opacity = (6 - this.timer.current) / 6;
                    }
                    else {
                        body.classList.remove('pulse-soft', 'pulse-heavy');
                        blood.style.opacity = 0;
                    }
                } else {
                    body.classList.remove('pulse-soft', 'pulse-heavy');
                    blood.style.opacity = 0;
                }
                
                if(this.timer.current <= 0) this.endGame("SÃœRE BÄ°TTÄ°");
            }

            updateHUD() {
                document.getElementById('scoreTxt').innerText = this.score; 
                document.getElementById('goldTxt').innerText = this.save.gold;
                document.getElementById('recordNormal').innerText = this.save.normal; 
                document.getElementById('recordTimed').innerText = this.save.timed;
                
                if (this.isMp) {
                    this.updateMpHUD();
                }
            }

            endGame(reason) {
                if(this.timer.active === false && this.gameOverTriggered && this.isMp) return;
                this.timer.active = false;
                this.timer.finishTime = Math.floor((Date.now() - this.timer.startTime) / 1000);
                if(this.score > this.save[this.currentMode]) this.save[this.currentMode] = this.score;
                this.syncSave();
                
                if (this.isMp) {
                    this.updateMpHUD();
                }
                
                if (this.mpSyncInterval) {
                    clearInterval(this.mpSyncInterval);
                    this.mpSyncInterval = null;
                }
                
                if(this.isMp) { 
                    if (this.conn && this.conn.open) {
                        this.conn.send({type:'finish', time: this.timer.finishTime}); 
                    }
                    this.updateHUD(); 
                    this.checkMatchEnd(); 
                }
                else this.showResult(reason);
            }

            checkMatchEnd() {
                const imDead = this.gameOverTriggered || (this.currentMode==='timed' && this.timer.current<=0);
                if(!this.oppAlive && imDead) this.showResult("MAÃ‡ TAMAMLANDI");
            }

            showResult(reason) {
                document.getElementById('overTitle').innerText = reason;
                document.getElementById('finalScore').innerText = "SKORUNUZ: " + this.score;
                if(this.isMp) {
                    let msg = `Siz: ${this.timer.finishTime}sn | Rakip: ${this.oppFinishTime}sn\n`;
                    if(this.score > this.oppScore) msg += "KAZANDINIZ! ðŸ†";
                    else if(this.score < this.oppScore) msg += "KAYBETTÄ°NÄ°Z!";
                    else msg += "BERABERE!";
                    document.getElementById('mpStats').innerText = msg;
                } else document.getElementById('mpStats').innerText = "";
                document.getElementById('overlay').style.display = 'flex';
                document.getElementById('gameOverBtns').style.display = 'none';
                setTimeout(() => { document.getElementById('gameOverBtns').style.display = 'flex'; }, 2000);
            }

            togglePwr(type) {
                const costs = { single: 150, cross: 500, nuke: 1000 };
                if(this.activePwr === type) this.activePwr = null;
                else if(this.save.gold >= costs[type]) {
                    if(type === 'nuke') {
                        let blocksRemoved = 0;
                        for(let r=0; r<8; r++) {
                            for(let c=0; c<8; c++) {
                                if(this.grid[r][c]) blocksRemoved++;
                            }
                        }
                        
                        this.save.gold -= 1000; 
                        this.grid = this.grid.map(r => r.fill(null));
                        this.refreshGrid(); 
                        this.syncSave(); 
                        this.updateUI(); 
                        Sound.sfx(200, 1000);
                        
                        if (this.currentAnimation !== 'default') {
                            const gridRect = this.gridEl.getBoundingClientRect();
                            this.applyAnimationEffect('explosion', gridRect.left + gridRect.width/2, gridRect.top + gridRect.height/2);
                        }
                        
                        if(blocksRemoved > 0) {
                            this.score += blocksRemoved * 10;
                            this.updateUI();
                        }
                        
                        this.spawnShapes();
                    } else { 
                        this.activePwr = type; 
                        Sound.sfx(800, 900); 
                    }
                }
                document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('active'));
                if(this.activePwr) document.getElementById('pwr-'+type).classList.add('active');
                this.refreshGrid();
            }

            handleCellClick(r, c) {
                if(!this.activePwr) return;
                
                let blocksRemoved = 0;
                
                if(this.activePwr === 'single') { 
                    if(this.grid[r][c]) blocksRemoved++;
                    this.grid[r][c] = null; 
                    this.save.gold -= 150; 
                }
                else if(this.activePwr === 'cross') { 
                    for(let i=0; i<8; i++) { 
                        if(this.grid[r][i]) blocksRemoved++;
                        this.grid[r][i] = null; 
                    }
                    for(let i=0; i<8; i++) { 
                        if(i !== r && this.grid[i][c]) blocksRemoved++;
                        this.grid[i][c] = null; 
                    }
                    this.save.gold -= 500; 
                }
                
                if (this.currentAnimation !== 'default') {
                    const cellEl = this.gridEl.children[r*8 + c];
                    const rect = cellEl.getBoundingClientRect();
                    this.applyAnimationEffect('click', rect.left + rect.width/2, rect.top + rect.height/2);
                }
                
                if(blocksRemoved > 0) {
                    this.score += blocksRemoved * 10;
                    this.updateUI();
                    if (this.isMp) {
                        this.updateMpHUD();
                    }
                }
                
                this.activePwr = null;
                document.querySelectorAll('.pwr-btn').forEach(b => b.classList.remove('active'));
                this.refreshGrid(); 
                this.syncSave(); 
                this.updateUI(); 
                Sound.sfx(500, 200);
                this.gameOverTriggered = false; 
                this.spawnShapes();
                if(this.isMp && this.conn && this.conn.open) this.conn.send({type:'sync', score:this.score, alive:true});
            }

            spawnShapes() {
                const shapes = [
                    [[1]], // 1x1
                    [[1,1]], // 1x2 yatay
                    [[1],[1]], // 2x1 dikey
                    [[1,1,1]], // 1x3 yatay
                    [[1],[1],[1]], // 3x1 dikey
                    [[1,1,1,1]], // 1x4 yatay
                    [[1],[1],[1],[1]], // 4x1 dikey
                    [[1,1],[1,1]], // 2x2
                    [[1,1,1],[0,1,0]], // T ÅŸekli
                    [[1,0],[1,0],[1,1]], // L ÅŸekli
                    [[0,1],[0,1],[1,1]], // Ters L
                    [[1,1,0],[0,1,1]], // Z ÅŸekli
                    [[0,1,1],[1,1,0]] // Ters Z
                ];
                
                for(let i=0; i<3; i++) if(!this.currentShapes[i]) {
                    let m = shapes[Math.floor(Math.random() * shapes.length)];
                    
                    if(Math.random() > 0.5) {
                        m = this.rotateMatrix(m);
                    }
                    
                    const blockSkin = this.save.equippedSkin.block;
                    let colorPalette = ['#f39c12', '#e74c3c', '#8e44ad', '#3498db', '#2ecc71'];
                    
                    if (blockSkin === 'nature') {
                        colorPalette = ['#8B4513', '#A0522D', '#228B22', '#D2691E', '#6B8E23'];
                    } else if (blockSkin === 'gems') {
                        colorPalette = ['#FFD700', '#C0C0C0', '#B9F2FF', '#FF69B4', '#32CD32'];
                    } else if (blockSkin === 'crystal') {
                        colorPalette = ['#00FFFF', '#FF00FF', '#FFFF00', '#FF4500', '#9370DB'];
                    }
                    
                    const c = colorPalette[Math.floor(Math.random() * colorPalette.length)];
                    this.currentShapes[i] = { matrix: m, color: c };
                    this.drawSlot(i, m, c);
                }
                this.checkMovesLeft();
            }

            rotateMatrix(matrix) {
                const rows = matrix.length;
                const cols = matrix[0].length;
                const rotated = Array(cols).fill().map(() => Array(rows).fill(0));
                
                for(let r=0; r<rows; r++) {
                    for(let c=0; c<cols; c++) {
                        rotated[c][rows-1-r] = matrix[r][c];
                    }
                }
                return rotated;
            }

            checkMovesLeft() {
                const hasAnyMove = this.currentShapes.some(s => {
                    if(!s) return false;
                    for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(this.canPlace(s.matrix, r, c)) return true;
                    return false;
                });
                
                if(!hasAnyMove && !this.gameOverTriggered) {
                    if(!this.noSpaceTimerActive) {
                        this.noSpaceTimerActive = true;
                        this.noSpaceTimer = 10;
                        document.getElementById('noSpaceTimer').style.display = 'block';
                        document.getElementById('noSpaceTime').innerText = this.noSpaceTimer;
                        
                        this.noSpaceTimerInterval = setInterval(() => {
                            this.noSpaceTimer--;
                            document.getElementById('noSpaceTime').innerText = this.noSpaceTimer;
                            
                            if(this.noSpaceTimer <= 0) {
                                this.stopNoSpaceTimer();
                                this.gameOverTriggered = true;
                                setTimeout(() => { 
                                    if(this.gameOverTriggered) this.endGame("YER KALMADI"); 
                                }, 100);
                            }
                            
                            const stillNoMoves = this.currentShapes.some(s => {
                                if(!s) return false;
                                for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(this.canPlace(s.matrix, r, c)) return true;
                                return false;
                            }) === false;
                            
                            if(stillNoMoves === false) {
                                this.stopNoSpaceTimer();
                            }
                        }, 1000);
                    }
                } else {
                    this.stopNoSpaceTimer();
                }
            }

            stopNoSpaceTimer() {
                if(this.noSpaceTimerInterval) {
                    clearInterval(this.noSpaceTimerInterval);
                    this.noSpaceTimerInterval = null;
                }
                this.noSpaceTimerActive = false;
                document.getElementById('noSpaceTimer').style.display = 'none';
            }

            handleGrab(e, idx) {
                if(!this.currentShapes[idx] || this.activePwr) return;
                e.preventDefault(); 
                Sound.sfx(600, 800);
                const el = document.getElementById('p-'+idx), m = this.currentShapes[idx].matrix;
                this.dragged = { 
                    el, 
                    idx, 
                    data: this.currentShapes[idx], 
                    parent: el.parentNode, 
                    pR: Math.floor(m.length/2), 
                    pC: Math.floor(m[0].length/2) 
                };
                el.classList.add('dragging'); 
                document.body.appendChild(el);
                this.onMove(e);
            }

            onMove(e) {
                if(!this.dragged) return;
                const t = e.touches ? e.touches[0] : e, bS = this.cellSize + 4;
                this.dragged.el.style.left = (t.clientX - (this.dragged.pC * bS) - (this.cellSize/2)) + 'px';
                this.dragged.el.style.top = (t.clientY - (this.dragged.pR * bS) - (this.cellSize/2) - 80) + 'px';
                this.clearGhost();
                const pos = this.getGridPos(t.clientX, t.clientY - 80);
                if(pos) {
                    const sR = pos.r - this.dragged.pR, sC = pos.c - this.dragged.pC;
                    if(this.canPlace(this.dragged.data.matrix, sR, sC)) {
                        let willCompleteLine = this.willCompleteLine(this.dragged.data.matrix, sR, sC);
                        
                        this.dragged.data.matrix.forEach((row, i) => row.forEach((v, j) => {
                            if(v) { 
                                const trgt = (sR+i)*8+(sC+j); 
                                if(trgt >=0 && trgt < 64) {
                                    this.gridEl.children[trgt].classList.add('ghost');
                                    if(willCompleteLine) {
                                        this.gridEl.children[trgt].style.boxShadow = '0 0 10px #00ff00';
                                    }
                                }
                            }
                        }));
                    }
                }
            }

            willCompleteLine(matrix, startR, startC) {
                let tempGrid = JSON.parse(JSON.stringify(this.grid));
                
                matrix.forEach((row, i) => row.forEach((v, j) => {
                    if(v) tempGrid[startR+i][startC+j] = 'temp';
                }));
                
                for(let r=0; r<8; r++) {
                    let complete = true;
                    for(let c=0; c<8; c++) {
                        if(!tempGrid[r][c]) complete = false;
                    }
                    if(complete) return true;
                }
                
                for(let c=0; c<8; c++) {
                    let complete = true;
                    for(let r=0; r<8; r++) {
                        if(!tempGrid[r][c]) complete = false;
                    }
                    if(complete) return true;
                }
                
                return false;
            }

            endDrag(e) {
                if(!this.dragged) return;
                const t = e.changedTouches ? e.changedTouches[0] : e, pos = this.getGridPos(t.clientX, t.clientY - 80);
                if(pos) {
                    const sR = pos.r - this.dragged.pR, sC = pos.c - this.dragged.pC;
                    if(this.canPlace(this.dragged.data.matrix, sR, sC)) {
                        this.dragged.data.matrix.forEach((row, i) => row.forEach((v, j) => { 
                            if(v) {
                                this.grid[sR+i][sC+j] = this.dragged.data.color; 
                                
                                if (this.currentAnimation !== 'default') {
                                    const cellEl = this.gridEl.children[(sR+i)*8 + (sC+j)];
                                    const rect = cellEl.getBoundingClientRect();
                                    setTimeout(() => {
                                        this.applyAnimationEffect('place', rect.left + rect.width/2, rect.top + rect.height/2);
                                    }, i * 50 + j * 20);
                                }
                            }
                        }));
                        this.score += 20; 
                        this.save.gold += 10;
                        this.currentShapes[this.dragged.idx] = null; 
                        this.dragged.el.remove();
                        Sound.sfx(400, 200);
                        
                        this.stopNoSpaceTimer();
                        
                        if(this.currentMode === 'timed') { 
                            this.timer.max = Math.max(6, this.timer.max - 0.4); 
                            this.timer.current = this.timer.max; 
                        }
                        this.checkLines();
                        if(this.currentShapes.every(x=>x===null)) this.spawnShapes();
                        else this.checkMovesLeft();
                        this.syncSave(); 
                        this.updateUI();
                        
                        if (this.isMp) {
                            this.updateMpHUD();
                            if (this.conn && this.conn.open) {
                                this.conn.send({type:'sync', score:this.score, alive:true});
                            }
                        }
                    } else { 
                        this.dragged.el.classList.remove('dragging'); 
                        this.dragged.parent.appendChild(this.dragged.el); 
                    }
                } else { 
                    this.dragged.el.classList.remove('dragging'); 
                    this.dragged.parent.appendChild(this.dragged.el); 
                }
                this.clearGhost(); 
                this.refreshGrid(); 
                this.dragged = null;
            }

            checkLines() {
                let rL = [], cL = [];
                for(let r=0; r<8; r++) if(this.grid[r].every(x=>x)) rL.push(r);
                for(let c=0; c<8; c++) { 
                    let f=true; 
                    for(let r=0; r<8; r++) if(!this.grid[r][c]) f=false; 
                    if(f) cL.push(c); 
                }
                if(rL.length + cL.length > 0) {
                    this.score += (rL.length + cL.length) * 100; 
                    this.save.gold += (rL.length + cL.length) * 20;
                    
                    if (this.currentAnimation !== 'default') {
                        const gridRect = this.gridEl.getBoundingClientRect();
                        const cellWidth = gridRect.width / 8;
                        const cellHeight = gridRect.height / 8;
                        
                        rL.forEach(r => {
                            for(let c=0; c<8; c++) {
                                const x = gridRect.left + c * cellWidth + cellWidth/2;
                                const y = gridRect.top + r * cellHeight + cellHeight/2;
                                this.applyAnimationEffect('clear', x, y);
                            }
                        });
                        
                        cL.forEach(c => {
                            for(let r=0; r<8; r++) {
                                const x = gridRect.left + c * cellWidth + cellWidth/2;
                                const y = gridRect.top + r * cellHeight + cellHeight/2;
                                this.applyAnimationEffect('clear', x, y);
                            }
                        });
                    }
                    
                    rL.forEach(r => this.grid[r].fill(null)); 
                    cL.forEach(c => { for(let r=0; r<8; r++) this.grid[r][c]=null; });
                    Sound.sfx(800, 1000); 
                    if(this.currentMode === 'timed') this.timer.current = this.timer.max;
                    
                    if (this.isMp) {
                        this.updateMpHUD();
                    }
                }
            }

            updateUI() {
                document.getElementById('scoreTxt').innerText = this.score; 
                document.getElementById('goldTxt').innerText = this.save.gold;
                document.getElementById('recordNormal').innerText = this.save.normal; 
                document.getElementById('recordTimed').innerText = this.save.timed;
            }

            reset() { 
                document.getElementById('overlay').style.display='none'; 
                this.start(this.currentMode); 
            }
            
            renderGrid() { 
                this.gridEl.innerHTML = ''; 
                for(let i=0; i<64; i++) { 
                    const c=document.createElement('div'); 
                    c.className='cell'; 
                    c.onclick = () => this.handleCellClick(Math.floor(i/8), i%8); 
                    this.gridEl.appendChild(c); 
                } 
            }
            
            refreshGrid() { 
                for(let i=0; i<64; i++) { 
                    const el = this.gridEl.children[i]; 
                    el.style.backgroundColor = this.grid[Math.floor(i/8)][i%8] || 'var(--cell-empty)'; 
                    el.className = 'cell' + (this.activePwr ? ' selectable' : ''); 
                    el.style.boxShadow = '';
                } 
            }
            
            getGridPos(x, y) { 
                const r = this.gridEl.getBoundingClientRect(); 
                const c = Math.floor((x-r.left)/(r.width/8)), 
                      row = Math.floor((y-r.top)/(r.height/8)); 
                return (row>=0&&row<8&&c>=0&&c<8)?{r:row,c}:null; 
            }
            
            canPlace(m, r, c) { 
                return m.every((row, i) => row.every((v, j) => !v || (r+i>=0 && r+i<8 && c+j>=0 && c+j<8 && !this.grid[r+i][c+j]))); 
            }
            
            clearGhost() { 
                document.querySelectorAll('.ghost').forEach(x=>{
                    x.classList.remove('ghost');
                    x.style.boxShadow = '';
                }); 
            }
            
            drawSlot(idx, m, color) { 
                const s=document.getElementById('slot'+idx); 
                s.innerHTML=''; 
                const w=document.createElement('div'); 
                w.className='shape-preview'; 
                w.id='p-'+idx; 
                w.style.gridTemplateColumns=`repeat(${m[0].length},1fr)`; 
                
                const blockSkin = this.save.equippedSkin.block;
                
                m.forEach(row=>row.forEach(v=>{ 
                    const b=document.createElement('div'); 
                    if(v){
                        b.className='block';
                        b.style.backgroundColor=color;
                        
                        if (blockSkin === 'gems') {
                            const gemTypes = ['diamond', 'emerald', 'ruby', 'sapphire', 'amber'];
                            const randomGem = gemTypes[Math.floor(Math.random() * gemTypes.length)];
                            b.className = 'block ' + randomGem;
                            b.style.background = '';
                        }
                    }else{
                        b.style.width='18px';
                    } 
                    w.appendChild(b); 
                })); 
                s.appendChild(w); 
            }
            
            updateMpLobbyUI() {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById('screenMpLobby').classList.remove('hidden');
                
                const lobbyId = this.isHost ? this.myId : (this.conn ? this.conn.peer : "---");
                document.getElementById('lobbyIdDisplay').innerText = "ODA ID: " + lobbyId;
                
                const list = document.getElementById('playerList');
                list.innerHTML = `<div class="player-tag"><span>SÄ°Z (${this.isHost?'HOST':'KATILIMCI'})</span></div>`;
                
                if(this.conn && this.conn.open) {
                    const kickBtn = this.isHost ? `<span class="kick-btn" onclick="game.mpKick()">AT</span>` : '';
                    list.innerHTML += `<div class="player-tag"><span>RAKÄ°P</span> ${kickBtn}</div>`;
                    
                    if(this.isHost) {
                        document.getElementById('mpStartBtn').disabled = false;
                    }
                } else {
                    if(this.isHost) {
                        document.getElementById('mpStartBtn').disabled = true;
                    }
                }
                
                if(!this.isHost) { 
                    document.getElementById('hostControls').classList.add('hidden'); 
                    document.getElementById('guestWaitMsg').classList.remove('hidden'); 
                } else { 
                    document.getElementById('hostControls').classList.remove('hidden'); 
                    document.getElementById('guestWaitMsg').classList.add('hidden'); 
                }
            }
        }

        const game = new Game();
        window.addEventListener('mousemove', e => game.onMove(e));
        window.addEventListener('touchmove', e => game.onMove(e), {passive:false});
        window.addEventListener('mouseup', e => game.endDrag(e));
        window.addEventListener('touchend', e => game.endDrag(e));
        
        window.addEventListener('orientationchange', function() {
            if (window.orientation === 90 || window.orientation === -90) {
                game.showGameAlert("LÃ¼tfen cihazÄ±nÄ±zÄ± dikey moda getirin!");
            }
        });
    </script>
</body>
</html>
